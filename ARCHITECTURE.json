{
  "project": "calendrier-zerah",
  "description": "Application de gestion de planning pour cabinet comptable Audit Up - Gestion des charges de travail, échéances fiscales et temps réels",
  "repository": "https://github.com/michaelzed75/calendrier-zerah",
  "deployment_url": "https://calendrier-zerah.vercel.app",
  "tech_stack": {
    "frontend": "React 18 + Vite 4",
    "styling": "Tailwind CSS",
    "icons": "lucide-react",
    "backend": "Supabase (PostgreSQL + Auth + Edge Functions)",
    "export": "xlsx (SheetJS) pour export Excel",
    "deployment": "Vercel (auto-deploy depuis GitHub)",
    "api_externe": "Pennylane API (synchronisation clients)",
    "typing": "JSDoc + @ts-check (typage progressif sans TypeScript)",
    "testing": "Vitest + React Testing Library"
  },
  "environment_variables": {
    "VITE_SUPABASE_URL": "URL du projet Supabase",
    "VITE_SUPABASE_ANON_KEY": "Clé anonyme Supabase (publique, OK en dur)",
    "VITE_PENNYLANE_API_KEY": "Clé API Pennylane (sensible, à mettre en env)",
    "UNSPLASH_ACCESS_KEY": "Clé API Unsplash pour images de fond (dans constants/theme.js)"
  },
  "structure": {
    "src/": {
      "App.jsx": {
        "lines": 733,
        "role": "Composant racine",
        "typing": "@ts-check + JSDoc annotations",
        "responsibilities": [
          "Gestion de l'authentification (user, userCollaborateur)",
          "Chargement initial des données depuis Supabase",
          "Navigation entre pages (currentPage state)",
          "Gestion du thème de fond et couleur d'accent",
          "Menu desktop et mobile",
          "Passage des props à toutes les pages enfants"
        ],
        "state_managed": [
          "user", "userCollaborateur", "authLoading",
          "collaborateurs", "collaborateurChefs", "clients", "charges",
          "impotsTaxes", "suiviEcheances", "loading",
          "currentPage", "showMobileMenu", "showThemeModal",
          "backgroundTheme", "backgroundImage", "accentColor"
        ]
      },
      "supabaseClient.js": {
        "role": "Configuration et export du client Supabase",
        "typing": "@ts-check + JSDoc"
      },
      "types.js": {
        "role": "Définitions de types JSDoc centralisées",
        "lines": 461,
        "exports": [
          "Collaborateur", "CollaborateurChef", "Client", "Charge",
          "ImpotsTaxes", "SuiviEcheance", "AccentColor", "BackgroundTheme",
          "GradientTheme", "UnsplashCategory", "ImageCredits",
          "AuthPageProps", "CalendarPageProps", "CollaborateursPageProps",
          "ClientsPageProps", "ImpotsTaxesPageProps", "RepartitionTVAPageProps",
          "TempsReelsPageProps", "ThemeModalProps", "CollaborateurModalProps",
          "ClientModalProps", "MergeClientModalProps", "AddChargeModalProps",
          "EditChargeModalProps", "ExportModalProps"
        ]
      },
      "main.jsx": "Point d'entrée React (ReactDOM.createRoot)",
      "index.css": "Import Tailwind CSS (@tailwind base/components/utilities)"
    },
    "src/components/pages/": {
      "AuthPage.jsx": {
        "lines": 460,
        "role": "Authentification",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Formulaire de connexion (email/password)",
          "Formulaire d'inscription",
          "Mot de passe oublié (reset via Supabase avec OTP)",
          "Messages d'erreur et succès"
        ],
        "props": ["authPage", "setAuthPage", "accent"],
        "tests": "AuthPage.test.jsx (13 tests)"
      },
      "CalendarPage.jsx": {
        "lines": 1424,
        "role": "Page principale - Calendrier",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Vue semaine (par défaut) avec colonnes par collaborateur",
          "Vue mois avec grille calendrier",
          "Vue jour détaillée",
          "Ajout/modification/suppression de charges",
          "Filtres par collaborateur, client, type",
          "Système d'alertes fiscales (bulles colorées)",
          "Export Excel avec sélection de période",
          "Affichage des temps réels vs budgétés",
          "Navigation semaine précédente/suivante"
        ],
        "props": [
          "collaborateurs", "collaborateurChefs", "clients", "charges", "setCharges",
          "getChefsOf", "getEquipeOf", "getAccessibleClients", "accent",
          "userCollaborateur", "impotsTaxes", "suiviEcheances", "setSuiviEcheances"
        ],
        "modals_used": ["AddChargeModal", "EditChargeModal", "ExportModal"],
        "refactoring_done": "Janvier 2025 - Réduction de 3773 à 1424 lignes (-62%) - Suppression code dupliqué des autres pages"
      },
      "CollaborateursPage.jsx": {
        "lines": 518,
        "role": "Gestion des collaborateurs",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Liste des collaborateurs avec statut actif/inactif",
          "Ajout/modification de collaborateur",
          "Assignation des chefs de mission (relation N-N)",
          "Modification email inline",
          "Envoi de rappels email (test admin / tous)",
          "Badge admin et chef de mission"
        ],
        "props": [
          "collaborateurs", "setCollaborateurs", "collaborateurChefs", "setCollaborateurChefs",
          "charges", "getChefsOf", "getEquipeOf", "accent", "isAdmin", "userCollaborateur"
        ],
        "modals_used": ["CollaborateurModal"]
      },
      "ClientsPage.jsx": {
        "lines": 750,
        "role": "Gestion des clients",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Liste des clients avec filtres (cabinet, recherche)",
          "Ajout/modification de client",
          "Synchronisation avec Pennylane API",
          "Fusion de clients (mapping Pennylane)",
          "Assignation chef de mission",
          "Distinction cabinet Zerah / Audit Up",
          "Configuration clé API Pennylane par client",
          "Test de connexion API avant sauvegarde (validation automatique)"
        ],
        "props": [
          "clients", "setClients", "charges", "setCharges",
          "collaborateurs", "accent", "userCollaborateur"
        ],
        "modals_used": ["ClientModal", "MergeClientModal"]
      },
      "TestsComptablesPage.jsx": {
        "lines": 1091,
        "role": "Tests comptables automatisés",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Sélection client avec recherche + persistance localStorage",
          "Sélection millésime (année fiscale)",
          "Exécution de tests comptables (doublons fournisseurs, relevé fournisseurs)",
          "Affichage des anomalies détectées avec sévérité",
          "Historique des exécutions par client avec chargement auto du dernier test",
          "Export Excel des résultats et des données analysées",
          "Configuration clé API depuis la page avec test de connexion",
          "Marquage fournisseurs 'au relevé' (checkbox persistée en BDD table fournisseurs_releve)",
          "Marquage fournisseurs 'ignorés' (exclus de l'analyse, section pliable)",
          "Calendrier 12 mois par fournisseur au relevé (vert=OK, orange=manquant, rouge=doublon)",
          "Panneau détail mois via DOM pur (zéro re-render React) pour la perf",
          "Liens PDF directs vers les factures Pennylane",
          "Suggestion de marquage au relevé (icône ampoule) si doublons classiques détectés",
          "Bouton restaurer pour fournisseurs masqués"
        ],
        "props": [
          "clients", "collaborateurs", "userCollaborateur",
          "getAccessibleClients", "accent"
        ],
        "access": "Clients avec clé API Pennylane configurée"
      },
      "HonorairesPage.jsx": {
        "lines": 715,
        "role": "Gestion des honoraires et abonnements Pennylane",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Synchronisation abonnements Pennylane (billing_subscriptions)",
          "Matching intelligent customers/clients (UUID puis nom)",
          "Filtrage doublons: seuls les customers avec abonnements sont matchés",
          "Vue par client avec totaux par famille (compta, social, juridique, support)",
          "Calcul montant mensuel (conversion annuel/mensuel)",
          "Détail des lignes de facturation par abonnement",
          "Liste clients actifs sans abonnement avec distinction:",
          "  - 'PL sans abo': client lié à Pennylane mais sans abonnement",
          "  - 'Pas dans PL': client non lié à Pennylane",
          "Filtres: cabinet, statut abonnement, recherche nom",
          "Totaux agrégés: comptabilité, social, juridique, support"
        ],
        "props": [
          "clients", "setClients", "collaborateurs", "accent", "userCollaborateur"
        ],
        "access": "Admin uniquement (is_admin)"
      },
      "SalairesPage.jsx": {
        "lines": 1591,
        "role": "Gestion des salaires collaborateurs - STRICTEMENT ADMIN",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Onglet Salaires: liste salaires actuels avec taux horaire chargé",
          "Onglet Primes: gestion des primes et exceptionnels par année",
          "Onglet Simulations: création scénarios d'augmentation",
          "Historique évolution salaires par collaborateur",
          "Calcul automatique: coût total, taux horaire brut/chargé",
          "Estimation charges patronales (45% par défaut)",
          "Masse salariale globale avec totaux",
          "Export Excel complet",
          "Simulations d'augmentation: % ou montant fixe",
          "Application des simulations: création nouveaux salaires"
        ],
        "props": [
          "collaborateurs", "accent", "userCollaborateur"
        ],
        "access": "Admin uniquement (is_admin) - PROTÉGÉ PAR RLS SUPABASE",
        "security": [
          "Niveau 1: Bouton menu masqué si non-admin",
          "Niveau 2: Composant affiche 'Accès refusé' si non-admin",
          "Niveau 3: RLS Supabase - requêtes retournent 0 lignes si non-admin"
        ]
      },
      "ImpotsTaxesPage.jsx": {
        "lines": 989,
        "role": "Suivi des échéances fiscales",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Grille annuelle par client et type d'échéance",
          "Configuration TVA (jour, périodicité)",
          "Configuration IS, CVAE, CFE, etc.",
          "Cases à cocher fait/pas fait par mois",
          "Sauvegarde automatique dans suivi_echeances",
          "Filtres par chef de mission",
          "Année fiscale sélectionnable"
        ],
        "props": [
          "clients", "collaborateurs", "impotsTaxes", "setImpotsTaxes",
          "suiviEcheances", "accent", "userCollaborateur"
        ],
        "access": "chef_mission ou admin uniquement"
      },
      "RepartitionTVAPage.jsx": {
        "lines": 452,
        "role": "Planification automatique TVA",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Sélection période de planification",
          "Liste des clients avec TVA configurée",
          "Assignation collaborateur par client",
          "Saisie durée estimée par client",
          "Répartition automatique sur jours ouvrés",
          "Validation capacité collaborateurs",
          "Prise en compte jours fériés français"
        ],
        "props": [
          "clients", "collaborateurs", "charges", "setCharges",
          "getEquipeOf", "accent", "userCollaborateur", "impotsTaxes"
        ],
        "access": "chef_mission uniquement"
      },
      "TempsReelsPage.jsx": {
        "lines": 1565,
        "role": "Import des temps réels Pennylane et analyse des écarts",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Import fichier Excel (format Pennylane)",
          "Mapping automatique collaborateurs (par email)",
          "Mapping clients avec création de liaisons",
          "Mode fusion intelligente ou remplacement",
          "Distinction par cabinet (Zerah/Audit Up)",
          "Prévisualisation avant import",
          "Gestion des clients non mappés",
          "Analyse des écarts budgété vs réel avec colonnes triables",
          "Colonne Cabinet (ZG/AU) dans l'analyse des écarts",
          "Colonne Détail travail (commentaires agrégés depuis Excel)",
          "Export Excel des écarts avec toutes les colonnes"
        ],
        "props": [
          "clients", "collaborateurs", "charges", "setCharges", "accent"
        ],
        "access": "chef_mission uniquement"
      }
    },
    "src/components/modals/": {
      "index.js": "Export centralisé: { ThemeModal, CollaborateurModal, ClientModal, MergeClientModal, AddChargeModal, EditChargeModal, ExportModal }",
      "ThemeModal.jsx": {
        "role": "Personnalisation visuelle",
        "typing": "@ts-check + JSDoc",
        "features": ["Sélection gradient de fond", "Images Unsplash par catégorie", "Couleur d'accent (pink, blue, green, etc.)"],
        "tests": "ThemeModal.test.jsx (10 tests)"
      },
      "CollaborateurModal.jsx": {
        "role": "Formulaire collaborateur",
        "typing": "@ts-check + JSDoc",
        "fields": ["nom", "email", "couleur", "actif", "est_chef_mission", "is_admin", "chefs assignés"]
      },
      "ClientModal.jsx": {
        "role": "Formulaire client",
        "typing": "@ts-check + JSDoc",
        "fields": ["nom", "cabinet", "actif", "chef_mission_id"]
      },
      "MergeClientModal.jsx": {
        "role": "Fusion de clients",
        "typing": "@ts-check + JSDoc",
        "purpose": "Lier un client Pennylane à un client existant (met à jour pennylane_id)"
      },
      "AddChargeModal.jsx": {
        "role": "Ajout de charge",
        "typing": "@ts-check + JSDoc",
        "fields": ["collaborateur", "client", "date", "heures", "type (budgété/réalisé)", "detail"]
      },
      "EditChargeModal.jsx": {
        "role": "Modification de charge",
        "typing": "@ts-check + JSDoc",
        "features": ["Modification heures/detail", "Suppression", "Ajout heures réalisées"]
      },
      "ExportModal.jsx": {
        "role": "Export Excel",
        "typing": "@ts-check + JSDoc",
        "features": ["Sélection date début/fin", "Export format xlsx"]
      }
    },
    "src/utils/": {
      "dateUtils.js": {
        "typing": "@ts-check + JSDoc",
        "exports": [
          "formatDateToYMD(date) - Date -> 'YYYY-MM-DD'",
          "parseDateString(str) - 'YYYY-MM-DD' -> Date locale"
        ],
        "tests": "dateUtils.test.js (10 tests)"
      },
      "testsComptables/": {
        "description": "Module de tests comptables automatisés",
        "files": {
          "index.js": "Export centralisé des fonctions de test",
          "pennylaneClientApi.js": {
            "role": "Client API Pennylane v2",
            "exports": [
              "callPennylaneAPI(apiKey, endpoint, params) - Appel générique via proxy",
              "getFEC(apiKey, millesime) - Récupère le FEC d'un exercice",
              "getSupplierInvoices(apiKey, millesime) - Factures fournisseurs",
              "getCustomerInvoices(apiKey, millesime) - Factures clients",
              "getBankTransactions(apiKey, millesime) - Opérations bancaires",
              "getChartOfAccounts(apiKey) - Plan comptable",
              "getSuppliers(apiKey) - Liste fournisseurs",
              "getLedgerAccounts(apiKey) - Tous les comptes du plan comptable",
              "testConnection(apiKey) - Test de validité de la clé API"
            ]
          },
          "testRunner.js": {
            "role": "Orchestrateur d'exécution des tests",
            "exports": [
              "runTest(params) - Exécute un test et sauvegarde les résultats",
              "getExecutionHistory(clientId) - Historique des exécutions",
              "getExecutionResults(executionId) - Résultats détaillés",
              "markAsProcessed(resultatId, collaborateurId) - Marquer comme traité",
              "getTestDefinitions() - Récupère les définitions de tests depuis la BDD"
            ]
          },
          "exportResults.js": {
            "role": "Export Excel des résultats de tests",
            "exports": [
              "exportTestResults({execution, resultats, client, test}) - Export anomalies en xlsx",
              "exportHistorique({executions, client}) - Export historique des exécutions",
              "exportDonneesAnalysees({donneesAnalysees, client, test, millesime}) - Export données analysées (même sans anomalies)"
            ]
          },
          "tests/": {
            "doublonsFournisseurs.js": "Détection doublons comptes 401 (similarité Levenshtein + mots communs significatifs)",
            "doubleSaisie.js": {
              "role": "Relevé fournisseurs - Suivi des fournisseurs avec 3 modes",
              "code": "double_saisie",
              "nom_affiche": "Relevé fournisseurs",
              "requiredData": "supplierInvoices (API /supplier_invoices)",
              "modes": {
                "fournisseur_au_releve": "Calendrier 12 mois: alerte doublon_releve (2+ factures/mois), alerte releve_manquant (0 facture/mois passé)",
                "fournisseur_normal": "Doublons classiques: montants égaux, récent > ancien, ou fichier relevé détecté, dans la tolérance (défaut 31j)",
                "fournisseur_ignore": "Exclu de l'analyse, listé à part"
              },
              "tests": "doubleSaisie.test.js (14 tests)"
            },
            "attestationAchats.js": {
              "role": "Attestation achats fournisseurs liste limitative",
              "code": "attestation_achats",
              "nom_affiche": "Attestation achats fournisseurs",
              "requiredData": "fec (API /ledger_entries)",
              "description": "Génère attestation HT/TTC par fournisseur, groupé par catégorie (Boissons, Food, etc.) avec détail vérification FEC",
              "options": {
                "comptesAchats": "Préfixes comptes à filtrer (défaut: ['601','602','606','607'])",
                "categories": "Catégories personnalisées [{id, nom, description}]",
                "categoriesFournisseurs": "Mapping fournisseur -> catégorie",
                "tauxTVA": "Taux TVA par catégorie (défaut: boissons 20%, food 10%, autres 20%)"
              },
              "output": {
                "excel_attestation": "Feuille récapitulatif par fournisseur/catégorie avec sous-totaux HT et TTC",
                "excel_verification": "Feuille détail FEC (toutes les écritures d'achats filtrées)"
              }
            },
            "index.js": "Registry des tests disponibles (testsRegistry, getTest, getAllTests, getTestsByCategory)"
          }
        }
      },
      "honoraires/": {
        "description": "Module de gestion des honoraires et abonnements Pennylane",
        "files": {
          "index.js": "Export centralisé: syncCustomersAndSubscriptions, getHonorairesResume, testConnection",
          "pennylaneCustomersApi.js": {
            "role": "Client API Pennylane v2 pour customers et abonnements",
            "exports": [
              "fetchAllCustomers(apiKey) - Récupère tous les customers (pagination)",
              "fetchAllSubscriptions(apiKey) - Récupère tous les abonnements",
              "fetchAllDataForSync(apiKey, onProgress) - Récupère customers + abonnements",
              "getSubscriptionInvoiceLines(apiKey, subscriptionId) - Lignes de facturation",
              "testConnection(apiKey) - Test de validité de la clé API"
            ]
          },
          "syncHonoraires.js": {
            "role": "Service de synchronisation honoraires",
            "exports": [
              "syncCustomersAndSubscriptions(supabase, apiKey, cabinet, onProgress) - Sync complète",
              "getHonorairesResume(supabase, clientId) - Résumé des honoraires"
            ],
            "matching_strategy": [
              "1. Par pennylane_customer_id existant (UUID)",
              "2. Par nom normalisé (exact)",
              "3. Par nom sans suffixes juridiques (SARL, SAS, etc.)",
              "4. Par nom normalisé (contient)",
              "5. Par nom sans suffixes (contient)",
              "IMPORTANT: Seuls les customers avec abonnements sont matchés (évite doublons)"
            ]
          }
        }
      },
      "salaires/": {
        "description": "Module de gestion des salaires - ACCES ADMIN UNIQUEMENT (RLS)",
        "files": {
          "index.js": "Export centralisé de tous les services et fonctions de calcul",
          "salairesService.js": {
            "role": "CRUD salaires collaborateurs",
            "exports": [
              "getSalairesActuels(supabase) - Salaire actuel de chaque collaborateur",
              "getHistoriqueSalaires(supabase, collaborateurId) - Historique évolution",
              "getSalaireCollaborateur(supabase, collaborateurId) - Salaire actuel d'un collab",
              "createSalaire(supabase, salaire) - Créer nouvelle entrée",
              "updateSalaire(supabase, id, updates) - Modifier",
              "deleteSalaire(supabase, id) - Supprimer"
            ]
          },
          "primesService.js": {
            "role": "CRUD primes et exceptionnels",
            "exports": [
              "getPrimes(supabase, annee?) - Liste des primes",
              "getPrimesCollaborateur(supabase, collaborateurId, annee?) - Primes d'un collab",
              "createPrime(supabase, prime) - Créer prime",
              "updatePrime(supabase, id, updates) - Modifier",
              "deletePrime(supabase, id) - Supprimer",
              "TYPES_PRIMES - Liste des types de primes disponibles"
            ]
          },
          "simulationsService.js": {
            "role": "Gestion des simulations d'augmentation",
            "exports": [
              "getSimulations(supabase, statut?) - Liste simulations",
              "getSimulation(supabase, id) - Détail avec lignes",
              "createSimulation(supabase, simulation) - Créer simulation",
              "updateSimulation(supabase, id, updates) - Modifier",
              "deleteSimulation(supabase, id) - Supprimer",
              "appliquerSimulation(supabase, id, validatedBy) - Créer les nouveaux salaires",
              "upsertLigneSimulation(supabase, ligne) - Ajouter/modifier ligne"
            ]
          },
          "calculsSalaires.js": {
            "role": "Fonctions de calcul pures",
            "exports": [
              "calculerCoutTotal(brut, charges) - Coût employeur",
              "calculerTauxHoraireBrut(brutAnnuel, heures) - Taux horaire brut",
              "calculerTauxHoraireCharge(brut, charges, heures) - Taux horaire chargé",
              "calculerAugmentation(salaire, valeur, type) - Nouveau salaire après augmentation",
              "estimerChargesPatronales(brut, taux?) - Estimation charges (45% défaut)",
              "calculerMasseSalariale(salaires) - Totaux brut/charges/coût",
              "formatMontant(montant) - Formatage euros",
              "formatTauxHoraire(taux) - Formatage €/h",
              "simulerAugmentationGlobale(salaires, pourcentage) - Simulation augmentation collective",
              "calculerEvolution(ancien, nouveau) - Calcul % évolution",
              "HEURES_ANNUELLES_LEGALES - 1607h",
              "TAUX_CHARGES_PATRONALES_DEFAUT - 0.45 (45%)"
            ]
          }
        }
      },
      "businessLogic.js": {
        "typing": "@ts-check + JSDoc",
        "role": "Fonctions de logique métier extraites pour testabilité",
        "exports": [
          "getChefsOf(collaborateurId, collaborateurChefs, collaborateurs) - Obtenir les chefs d'un collaborateur",
          "getEquipeOf(chefId, collaborateurChefs, collaborateurs) - Obtenir l'équipe d'un chef",
          "getAccessibleClients(collaborateur, clients, collaborateurChefs, collaborateurs) - Clients accessibles selon permissions",
          "canEditCharge(userCollaborateur, chargeCollaborateurId, ...) - Vérifier droit de modification",
          "getVisibleCharges(userCollaborateur, charges, ...) - Charges visibles selon permissions",
          "getChargesForDate(charges, collaborateurId, dateStr) - Filtrer charges par date",
          "getTotalHoursForDate(charges, collaborateurId, dateStr) - Total heures par date",
          "getAggregatedByClient(charges, clients, collaborateurId, dateStr) - Heures agrégées par client",
          "getVisibleCollaborateurs(userCollaborateur, activeCollaborateurs, collaborateurChefs) - Collaborateurs visibles selon droits",
          "hasBudgetForDate(charges, collaborateurId, dateStr) - Vérifie si budget existe",
          "hasTempsReelsForDate(tempsReels, collaborateurId, dateStr) - Vérifie si temps réels saisis",
          "isJourOuvre(date) - Vérifie si jour ouvré (lundi-vendredi)",
          "getWeekDays(currentDate, weekOffset) - Calcule les 7 jours d'une semaine",
          "getWeekTotal(charges, collaborateurId, weekDays, formatDateToYMD) - Total heures sur semaine",
          "countAlerts(collaborateurs, charges, tempsReels, ...) - Compte les alertes collaborateurs"
        ],
        "tests": [
          "businessLogic.test.js (22 tests unitaires)",
          "businessLogic.scenarios.test.js (25 tests scénarios métier)",
          "calendarLogic.test.js (35 tests fonctions calendrier)"
        ]
      }
    },
    "src/constants/": {
      "theme.js": {
        "typing": "@ts-check + JSDoc",
        "exports": [
          "GRADIENT_THEMES - Liste des dégradés disponibles",
          "ACCENT_COLORS - Couleurs d'accent (pink, blue, green, purple, orange)",
          "UNSPLASH_CATEGORIES - Catégories d'images (nature, city, abstract, etc.)",
          "UNSPLASH_ACCESS_KEY - Clé API Unsplash"
        ],
        "tests": "theme.test.js (16 tests)"
      }
    },
    "src/test/": {
      "setup.js": "Configuration jest-dom pour les tests"
    }
  },
  "testing": {
    "framework": "Vitest + React Testing Library",
    "config_file": "vitest.config.js",
    "commands": {
      "npm test": "Lance les tests en mode watch",
      "npm run test:run": "Lance les tests une fois",
      "npm run test:coverage": "Lance les tests avec rapport de couverture"
    },
    "test_files": {
      "src/utils/dateUtils.test.js": {
        "tests": 10,
        "coverage": "formatDateToYMD, parseDateString"
      },
      "src/utils/businessLogic.test.js": {
        "tests": 22,
        "coverage": "getChefsOf, getEquipeOf, getAccessibleClients, canEditCharge, getVisibleCharges"
      },
      "src/utils/businessLogic.scenarios.test.js": {
        "tests": 25,
        "coverage": "Scénarios métier réalistes cabinet comptable (hiérarchie, permissions, cas limites)"
      },
      "src/constants/theme.test.js": {
        "tests": 16,
        "coverage": "GRADIENT_THEMES, ACCENT_COLORS, UNSPLASH_CATEGORIES"
      },
      "src/components/pages/AuthPage.test.jsx": {
        "tests": 13,
        "coverage": "Rendu formulaires login/register/forgot, navigation"
      },
      "src/components/modals/ThemeModal.test.jsx": {
        "tests": 10,
        "coverage": "Rendu, onglets, sélection thèmes et couleurs"
      },
      "src/utils/calendarLogic.test.js": {
        "tests": 35,
        "coverage": "Fonctions calendrier: getChargesForDate, getTotalHoursForDate, getAggregatedByClient, getVisibleCollaborateurs, hasBudgetForDate, hasTempsReelsForDate, isJourOuvre, getWeekDays, getWeekTotal, countAlerts"
      },
      "src/utils/honoraires/syncHonoraires.test.js": {
        "tests": 27,
        "coverage": "normalizeString, removeJuridicalSuffixes, matchCustomerToClient, getFamilleFromLabel, filtrage customers sans abonnement, cas réels doublons cabinet"
      },
      "src/utils/testsComptables/tests/doubleSaisie.test.js": {
        "tests": 14,
        "coverage": "Métadonnées test, doublons classiques (montant récent > ancien, tolérance jours), doublons relevé (2+ factures/mois), extraction nom fournisseur, statistiques, filtrage factures invalides"
      },
      "src/utils/salaires/calculsSalaires.test.js": {
        "tests": 54,
        "coverage": "Constantes, calculerCoutTotal, calculerTauxHoraireBrut, calculerTauxHoraireCharge, calculerAugmentation, estimerChargesPatronales, calculerMasseSalariale, simulerAugmentationGlobale, formatMontant, formatTauxHoraire, calculerEvolution, scénarios métier rentabilité"
      }
    },
    "total_tests": 226
  },
  "database_tables": {
    "collaborateurs": {
      "description": "Utilisateurs du système (collaborateurs du cabinet)",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "nom": "TEXT NOT NULL",
        "email": "TEXT UNIQUE",
        "actif": "BOOLEAN DEFAULT true",
        "est_chef_mission": "BOOLEAN DEFAULT false",
        "is_admin": "BOOLEAN DEFAULT false",
        "couleur": "TEXT (code hex pour affichage calendrier)"
      }
    },
    "collaborateur_chefs": {
      "description": "Relation N-N entre collaborateurs et leurs chefs de mission",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "chef_id": "INTEGER REFERENCES collaborateurs(id)"
      },
      "note": "Un collaborateur peut avoir plusieurs chefs, un chef peut avoir plusieurs collaborateurs"
    },
    "clients": {
      "description": "Clients du cabinet (entreprises)",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "nom": "TEXT NOT NULL",
        "actif": "BOOLEAN DEFAULT true",
        "cabinet": "TEXT ('Zerah Fiduciaire' ou 'Audit Up')",
        "chef_mission_id": "INTEGER REFERENCES collaborateurs(id)",
        "pennylane_id": "TEXT (ID du client dans Pennylane - DEPRECATED)",
        "pennylane_customer_id": "TEXT (UUID Pennylane = external_reference de l'API v2)",
        "code_silae": "TEXT (code client Silae pour mapping social)",
        "mode_facturation_social": "TEXT ('forfait' ou 'reel')"
      }
    },
    "charges": {
      "description": "Charges de travail planifiées et réalisées",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "client_id": "INTEGER REFERENCES clients(id)",
        "date_charge": "DATE NOT NULL",
        "heures": "DECIMAL (heures budgétées)",
        "heures_realisees": "DECIMAL DEFAULT 0 (heures réellement passées)",
        "type": "TEXT ('budgété' ou 'réalisé')",
        "detail": "TEXT (description de la tâche: 'Bilan', 'TVA', 'Paie', etc.)"
      }
    },
    "impots_taxes": {
      "description": "Configuration des échéances fiscales par client et année",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id)",
        "annee_fiscale": "INTEGER (ex: 2025)",
        "tva_jour": "INTEGER (jour du mois pour TVA, ex: 19)",
        "tva_periodicite": "TEXT ('mensuelle', 'trimestrielle', 'annuelle')",
        "is_jour": "INTEGER (jour pour IS)",
        "is_periodicite": "TEXT",
        "cvae_jour": "INTEGER",
        "cfe_jour": "INTEGER",
        "das2_jour": "INTEGER",
        "liasse_jour": "INTEGER",
        "...": "autres champs pour chaque type d'impôt"
      }
    },
    "suivi_echeances": {
      "description": "Suivi de réalisation des échéances fiscales",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id)",
        "type_echeance": "TEXT ('tva', 'is', 'cvae', etc.)",
        "mois": "INTEGER (1-12)",
        "annee": "INTEGER",
        "fait": "BOOLEAN DEFAULT false",
        "date_realisation": "TIMESTAMP"
      }
    }
  },
  "user_roles": {
    "admin": {
      "field": "collaborateurs.is_admin = true",
      "description": "Administrateur - accès complet",
      "can_access": ["calendar", "collaborateurs", "clients", "impots", "tva", "temps_reels"],
      "special_permissions": [
        "Voir tous les collaborateurs et clients",
        "Modifier les droits admin/chef",
        "Envoyer rappels email à tous"
      ]
    },
    "chef_mission": {
      "field": "collaborateurs.est_chef_mission = true",
      "description": "Chef de mission - gère une équipe",
      "can_access": ["calendar", "collaborateurs", "clients", "impots", "tva", "temps_reels"],
      "special_permissions": [
        "Voir son équipe (collaborateurs assignés)",
        "Voir ses clients (chef_mission_id = son id)",
        "Planifier les charges de son équipe"
      ]
    },
    "collaborateur": {
      "field": "est_chef_mission = false AND is_admin = false",
      "description": "Collaborateur standard",
      "can_access": ["calendar", "collaborateurs (lecture)", "clients (lecture)"],
      "special_permissions": [
        "Voir uniquement ses propres charges",
        "Voir les clients de ses chefs"
      ]
    }
  },
  "helper_functions_in_app": {
    "note": "Ces fonctions sont définies dans App.jsx et utilisent les fonctions de businessLogic.js",
    "getChefsOf(collaborateurId)": "Retourne la liste des chefs d'un collaborateur",
    "getEquipeOf(chefId)": "Retourne la liste des membres de l'équipe d'un chef",
    "getAccessibleClients(collaborateur)": "Retourne les clients accessibles selon le rôle",
    "loadAllData()": "Charge toutes les données depuis Supabase",
    "loadUserCollaborateur(email)": "Charge le collaborateur lié à l'utilisateur connecté"
  },
  "key_features_detail": {
    "calendar_views": {
      "week": "Vue par défaut - colonnes = collaborateurs filtrés, lignes = jours de la semaine",
      "month": "Grille calendrier mensuelle avec charges agrégées par jour",
      "day": "Vue journée détaillée"
    },
    "alerts_system": {
      "description": "Bulles colorées sur le calendrier indiquant les échéances fiscales",
      "colors": {
        "red": "Échéance non faite et date dépassée",
        "orange": "Échéance à faire dans les 3 jours",
        "green": "Échéance faite"
      },
      "types": ["TVA", "IS", "CVAE", "CFE", "DAS2", "Liasse fiscale"]
    },
    "pennylane_integration": {
      "sync_clients": "GET /api/customers - récupère la liste des clients",
      "mapping": "Liaison client local <-> pennylane_id pour import temps",
      "temps_import": "Export Excel depuis Pennylane -> import dans charges"
    },
    "excel_import_temps_reels": {
      "format": "Excel exporté depuis Pennylane (colonnes: Date, Collaborateur, Client, Heures, etc.)",
      "mapping_collab": "Automatique par email",
      "mapping_client": "Manuel ou automatique si pennylane_id existe",
      "modes": {
        "fusion": "Ajoute les heures aux charges existantes",
        "remplacement": "Remplace les heures réalisées existantes"
      }
    },
    "tva_auto_planning": {
      "inputs": ["Période (date début/fin)", "Heures par client", "Collaborateur assigné"],
      "algorithm": "Répartit les heures sur les jours ouvrés en respectant max 8h/jour",
      "constraints": ["Jours fériés français exclus", "Week-ends exclus", "Capacité collaborateur validée"]
    }
  },
  "cabinets": {
    "zerah": {
      "id": "zerah",
      "description": "Cabinet Zerah (cabinet principal)"
    },
    "audit_up": {
      "id": "audit_up",
      "description": "Cabinet Audit Up"
    }
  },
  "common_operations": {
    "add_charge": "CalendarPage -> AddChargeModal -> supabase.from('charges').insert()",
    "edit_charge": "CalendarPage -> EditChargeModal -> supabase.from('charges').update()",
    "delete_charge": "EditChargeModal -> supabase.from('charges').delete()",
    "sync_pennylane": "ClientsPage -> fetch Pennylane API -> compare & insert new clients",
    "import_temps": "TempsReelsPage -> parse Excel -> map collaborateurs/clients -> update charges.heures_realisees",
    "mark_echeance_done": "ImpotsTaxesPage ou CalendarPage -> supabase.from('suivi_echeances').upsert()"
  },
  "styling_conventions": {
    "background": "bg-slate-800/90 backdrop-blur-sm (cartes)",
    "borders": "border border-slate-700 rounded-lg",
    "buttons_primary": "${accent.color} text-white ${accent.hover}",
    "buttons_secondary": "bg-slate-700 hover:bg-slate-600 text-slate-300",
    "inputs": "bg-slate-700 text-white rounded px-3 py-2 border border-slate-600",
    "text_primary": "text-white",
    "text_secondary": "text-slate-300 ou text-slate-400"
  },
  "known_issues_and_todos": [
    "Pas de gestion d'erreurs centralisée",
    "Les jours fériés sont codés en dur (2025-2027)",
    "Les clés API sont en dur dans le code (Unsplash, Supabase) - à déplacer vers .env"
  ],
  "api/": {
    "description": "Fonctions serverless Vercel",
    "pennylane-proxy.js": {
      "role": "Proxy API Pennylane pour éviter CORS",
      "endpoint": "/api/pennylane-proxy",
      "method": "GET/POST",
      "headers_required": ["X-Pennylane-Api-Key"],
      "query_params": ["endpoint", "...autres params transmis à Pennylane"],
      "target_api": "https://app.pennylane.com/api/external/v2"
    }
  },
  "database_tables_honoraires": {
    "abonnements": {
      "description": "Abonnements (subscriptions) Pennylane synchronisés",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id) NOT NULL",
        "pennylane_subscription_id": "INTEGER UNIQUE NOT NULL",
        "label": "TEXT (nom de l'abonnement)",
        "status": "TEXT ('in_progress', 'not_started', 'stopped', 'finished')",
        "frequence": "TEXT ('monthly', 'yearly')",
        "intervalle": "INTEGER DEFAULT 1",
        "jour_facturation": "INTEGER",
        "date_debut": "DATE",
        "date_fin": "DATE",
        "total_ttc": "DECIMAL(12,2)",
        "total_ht": "DECIMAL(12,2)",
        "total_tva": "DECIMAL(12,2)",
        "synced_at": "TIMESTAMP",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "updated_at": "TIMESTAMP DEFAULT NOW()"
      }
    },
    "abonnements_lignes": {
      "description": "Lignes de facturation des abonnements",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "abonnement_id": "INTEGER REFERENCES abonnements(id) ON DELETE CASCADE",
        "pennylane_line_id": "INTEGER",
        "label": "TEXT NOT NULL (nom du produit)",
        "famille": "TEXT ('comptabilite', 'social', 'juridique', 'support')",
        "quantite": "DECIMAL(10,2) DEFAULT 1",
        "montant_ttc": "DECIMAL(12,2)",
        "montant_ht": "DECIMAL(12,2)",
        "montant_tva": "DECIMAL(12,2)",
        "taux_tva": "TEXT",
        "description": "TEXT"
      }
    },
    "produits_facturation": {
      "description": "Référentiel des produits de facturation avec mapping famille",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "label": "TEXT UNIQUE NOT NULL",
        "famille": "TEXT ('comptabilite', 'social', 'juridique', 'support')",
        "inclus_calcul_temps": "BOOLEAN DEFAULT true",
        "actif": "BOOLEAN DEFAULT true"
      }
    },
    "types_mission": {
      "description": "Référentiel des types de mission pour calcul rentabilité",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "code": "TEXT UNIQUE NOT NULL",
        "libelle": "TEXT NOT NULL",
        "famille": "TEXT ('comptabilite', 'social', 'juridique', 'support')",
        "inclus_calcul_rentabilite": "BOOLEAN DEFAULT true"
      }
    }
  },
  "database_tables_tests_comptables": {
    "fournisseurs_releve": {
      "description": "Marquage des fournisseurs 'au relevé' ou 'ignorés' par client",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id) NOT NULL",
        "supplier_id": "TEXT NOT NULL (ID fournisseur Pennylane)",
        "supplier_name": "TEXT (nom fournisseur pour affichage)",
        "type": "TEXT ('releve' ou 'ignore') DEFAULT 'releve'",
        "created_by": "INTEGER REFERENCES collaborateurs(id)",
        "created_at": "TIMESTAMP DEFAULT NOW()"
      },
      "unique_constraint": "UNIQUE(client_id, supplier_id)",
      "used_by": "TestsComptablesPage.jsx - persistance des marquages fournisseurs"
    },
    "tests_comptables_executions": {
      "description": "Historique des exécutions de tests",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id)",
        "test_code": "TEXT (code du test exécuté)",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "millesime": "INTEGER (année fiscale)",
        "date_execution": "TIMESTAMP DEFAULT NOW()",
        "statut": "TEXT ('en_cours', 'termine', 'erreur')",
        "duree_ms": "INTEGER",
        "nombre_anomalies": "INTEGER DEFAULT 0"
      }
    },
    "tests_comptables_resultats": {
      "description": "Anomalies détectées par les tests",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "execution_id": "INTEGER REFERENCES tests_comptables_executions(id)",
        "type_anomalie": "TEXT",
        "severite": "TEXT ('info', 'warning', 'error', 'critical')",
        "donnees": "JSONB (données spécifiques à l'anomalie)",
        "commentaire": "TEXT",
        "traite": "BOOLEAN DEFAULT false",
        "traite_par": "INTEGER REFERENCES collaborateurs(id)",
        "traite_le": "TIMESTAMP"
      }
    }
  },
  "database_tables_salaires": {
    "_security": "TOUTES CES TABLES SONT PROTÉGÉES PAR RLS - ACCÈS ADMIN UNIQUEMENT",
    "salaires_collaborateurs": {
      "description": "Historique des salaires - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id) ON DELETE CASCADE",
        "annee": "INTEGER NOT NULL",
        "date_effet": "DATE NOT NULL (date d'effet du salaire)",
        "salaire_brut_annuel": "DECIMAL(12,2) NOT NULL",
        "charges_patronales_annuel": "DECIMAL(12,2) DEFAULT 0",
        "heures_annuelles": "INTEGER DEFAULT 1607 (base légale)",
        "motif_modification": "TEXT (Embauche, Augmentation, Promotion...)",
        "notes": "TEXT",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "updated_at": "TIMESTAMP DEFAULT NOW()",
        "created_by": "INTEGER REFERENCES collaborateurs(id)"
      },
      "rls_policy": "admin_full_access_salaires - USING (is_current_user_admin())"
    },
    "salaires_primes": {
      "description": "Primes et exceptionnels - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id) ON DELETE CASCADE",
        "annee": "INTEGER NOT NULL",
        "mois": "INTEGER (1-12, NULL = annuel)",
        "date_versement": "DATE",
        "type_prime": "TEXT (prime_exceptionnelle, prime_objectifs, 13eme_mois, participation, interessement, prime_anciennete, prime_vacances, autre)",
        "libelle": "TEXT NOT NULL",
        "montant_brut": "DECIMAL(10,2) NOT NULL",
        "charges_patronales": "DECIMAL(10,2) DEFAULT 0",
        "notes": "TEXT",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "created_by": "INTEGER REFERENCES collaborateurs(id)"
      },
      "rls_policy": "admin_full_access_primes - USING (is_current_user_admin())"
    },
    "salaires_simulations": {
      "description": "Simulations budgétaires augmentations - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "nom_simulation": "TEXT NOT NULL",
        "annee_cible": "INTEGER NOT NULL",
        "date_effet_prevue": "DATE",
        "statut": "TEXT (brouillon, valide, applique)",
        "notes": "TEXT",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "created_by": "INTEGER REFERENCES collaborateurs(id)",
        "validated_at": "TIMESTAMP",
        "validated_by": "INTEGER REFERENCES collaborateurs(id)"
      },
      "rls_policy": "admin_full_access_simulations - USING (is_current_user_admin())"
    },
    "salaires_simulations_lignes": {
      "description": "Détail des simulations par collaborateur - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "simulation_id": "INTEGER REFERENCES salaires_simulations(id) ON DELETE CASCADE",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "salaire_actuel_brut": "DECIMAL(12,2)",
        "charges_actuelles": "DECIMAL(12,2)",
        "type_augmentation": "TEXT (montant, pourcentage)",
        "valeur_augmentation": "DECIMAL(10,2)",
        "nouveau_salaire_brut": "DECIMAL(12,2)",
        "nouvelles_charges": "DECIMAL(12,2)",
        "notes": "TEXT"
      },
      "rls_policy": "admin_full_access_simulations_lignes - USING (is_current_user_admin())"
    }
  },
  "recent_changes": {
    "2025-01": [
      "Ajout typage JSDoc + @ts-check sur tous les fichiers",
      "Création de types.js avec toutes les définitions de types",
      "Extraction des fonctions métier dans businessLogic.js",
      "Setup framework de tests Vitest + React Testing Library",
      "Ajout de 96 tests (unitaires, composants, scénarios métier)",
      "Fix imports icônes manquants sur plusieurs pages",
      "Extension businessLogic.js avec 10 nouvelles fonctions calendrier",
      "Création calendarLogic.test.js (35 tests pré-refactoring)",
      "Refactoring CalendarPage.jsx: 3773 → 1424 lignes (-62%) - suppression code dupliqué",
      "Total tests: 131",
      "Ajout module tests comptables (testsComptables/)",
      "Ajout proxy API Pennylane (api/pennylane-proxy.js)",
      "Ajout page TestsComptablesPage.jsx",
      "Ajout validation clé API Pennylane avec test de connexion dans ClientsPage",
      "Ajout champ pennylane_client_api_key sur clients",
      "Analyse des écarts: ajout colonne Cabinet (ZG/AU) triable",
      "Analyse des écarts: ajout colonne Détail travail (commentaires agrégés depuis import Excel)",
      "Export Excel des écarts enrichi avec Cabinet et Détail travail",
      "Tri alphabétique des listes de clients dans toute l'application",
      "Recherche intégrée dans les dropdowns clients (EditChargeModal, TestsComptablesPage)",
      "Amélioration UX: ClientsPage, MergeClientModal, RepartitionTVAPage, TempsReelsPage triés",
      "Ajout module honoraires (src/utils/honoraires/)",
      "Ajout page HonorairesPage.jsx (admin only)",
      "Migration BDD: pennylane_customer_id changé de INTEGER à TEXT (UUID)",
      "Sync Pennylane: matching intelligent avec filtrage doublons (seuls customers avec abonnements)",
      "Tables BDD: abonnements, abonnements_lignes, produits_facturation, types_mission",
      "Ajout module salaires (src/utils/salaires/) - ADMIN ONLY avec RLS",
      "Ajout page SalairesPage.jsx avec 3 onglets: Salaires, Primes, Simulations",
      "Tables BDD salaires: salaires_collaborateurs, salaires_primes, salaires_simulations, salaires_simulations_lignes",
      "Sécurité RLS: fonction is_current_user_admin() + politiques sur toutes tables salaires",
      "Calcul taux horaire chargé basé sur 1607h annuelles légales",
      "Simulations d'augmentation: création, application vers nouveaux salaires"
    ],
    "2025-02": [
      "Test doubleSaisie renommé 'Relevé fournisseurs' - refonte complète du test",
      "Marquage fournisseurs 'au relevé' et 'ignorés' persisté en BDD (table fournisseurs_releve)",
      "Calendrier 12 mois par fournisseur au relevé (vert/orange/rouge/grisé)",
      "Mois cliquables dans calendrier relevé fournisseurs avec panneau détail",
      "Panneau détails mois via DOM pur (zéro re-render React) pour optimisation perf",
      "Liens PDF directs vers factures Pennylane dans panneau détail",
      "Suggestion marquage au relevé (icône ampoule) si doublons classiques détectés",
      "Section fournisseurs ignorés pliable avec bouton Restaurer",
      "TestsComptablesPage: 632 → 1091 lignes",
      "Ajout tests: doubleSaisie.test.js (14 tests), calculsSalaires.test.js (54 tests)",
      "Total tests: 158 → 226"
    ]
  }
}
