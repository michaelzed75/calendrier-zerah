{
  "project": "calendrier-zerah",
  "description": "Application de gestion de planning pour cabinet comptable Audit Up - Gestion des charges de travail, échéances fiscales et temps réels",
  "repository": "https://github.com/michaelzed75/calendrier-zerah",
  "deployment_url": "https://calendrier-zerah.vercel.app",
  "tech_stack": {
    "frontend": "React 18 + Vite 4",
    "styling": "Tailwind CSS",
    "icons": "lucide-react",
    "backend": "Supabase (PostgreSQL + Auth + Edge Functions)",
    "export": "xlsx (SheetJS) pour export Excel, docx pour export Word",
    "deployment": "Vercel (auto-deploy depuis GitHub)",
    "api_externe": "Pennylane API (synchronisation clients et abonnements, X-Company-Id par cabinet)",
    "typing": "JSDoc + @ts-check (typage progressif sans TypeScript)",
    "testing": "Vitest + React Testing Library"
  },
  "environment_variables": {
    "VITE_SUPABASE_URL": "URL du projet Supabase",
    "VITE_SUPABASE_ANON_KEY": "Clé anonyme Supabase (publique, OK en dur)",
    "VITE_PENNYLANE_API_KEY": "Clé API Pennylane (sensible, à mettre en env)",
    "UNSPLASH_ACCESS_KEY": "Clé API Unsplash pour images de fond (dans constants/theme.js)"
  },
  "structure": {
    "src/": {
      "App.jsx": {
        "lines": 733,
        "role": "Composant racine",
        "typing": "@ts-check + JSDoc annotations",
        "responsibilities": [
          "Gestion de l'authentification (user, userCollaborateur)",
          "Chargement initial des données depuis Supabase",
          "Navigation entre pages (currentPage state)",
          "Gestion du thème de fond et couleur d'accent",
          "Menu desktop et mobile",
          "Passage des props à toutes les pages enfants"
        ],
        "state_managed": [
          "user", "userCollaborateur", "authLoading",
          "collaborateurs", "collaborateurChefs", "clients", "charges",
          "impotsTaxes", "suiviEcheances", "loading",
          "currentPage", "showMobileMenu", "showThemeModal",
          "backgroundTheme", "backgroundImage", "accentColor"
        ]
      },
      "supabaseClient.js": {
        "role": "Configuration et export du client Supabase",
        "typing": "@ts-check + JSDoc"
      },
      "types.js": {
        "role": "Définitions de types JSDoc centralisées",
        "lines": 461,
        "exports": [
          "Collaborateur", "CollaborateurChef", "Client", "Charge",
          "ImpotsTaxes", "SuiviEcheance", "AccentColor", "BackgroundTheme",
          "GradientTheme", "UnsplashCategory", "ImageCredits",
          "AuthPageProps", "CalendarPageProps", "CollaborateursPageProps",
          "ClientsPageProps", "ImpotsTaxesPageProps", "RepartitionTVAPageProps",
          "TempsReelsPageProps", "ThemeModalProps", "CollaborateurModalProps",
          "ClientModalProps", "MergeClientModalProps", "AddChargeModalProps",
          "EditChargeModalProps", "ExportModalProps"
        ]
      },
      "main.jsx": "Point d'entrée React (ReactDOM.createRoot)",
      "index.css": "Import Tailwind CSS (@tailwind base/components/utilities)"
    },
    "src/components/pages/": {
      "AuthPage.jsx": {
        "lines": 460,
        "role": "Authentification",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Formulaire de connexion (email/password)",
          "Formulaire d'inscription",
          "Mot de passe oublié (reset via Supabase avec OTP)",
          "Messages d'erreur et succès"
        ],
        "props": ["authPage", "setAuthPage", "accent"],
        "tests": "AuthPage.test.jsx (13 tests)"
      },
      "CalendarPage.jsx": {
        "lines": 1424,
        "role": "Page principale - Calendrier",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Vue semaine (par défaut) avec colonnes par collaborateur",
          "Vue mois avec grille calendrier",
          "Vue jour détaillée",
          "Ajout/modification/suppression de charges",
          "Filtres par collaborateur, client, type",
          "Système d'alertes fiscales (bulles colorées)",
          "Export Excel avec sélection de période",
          "Affichage des temps réels vs budgétés",
          "Navigation semaine précédente/suivante"
        ],
        "props": [
          "collaborateurs", "collaborateurChefs", "clients", "charges", "setCharges",
          "getChefsOf", "getEquipeOf", "getAccessibleClients", "accent",
          "userCollaborateur", "impotsTaxes", "suiviEcheances", "setSuiviEcheances"
        ],
        "modals_used": ["AddChargeModal", "EditChargeModal", "ExportModal"],
        "refactoring_done": "Janvier 2025 - Réduction de 3773 à 1424 lignes (-62%) - Suppression code dupliqué des autres pages"
      },
      "CollaborateursPage.jsx": {
        "lines": 518,
        "role": "Gestion des collaborateurs",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Liste des collaborateurs avec statut actif/inactif",
          "Ajout/modification de collaborateur",
          "Assignation des chefs de mission (relation N-N)",
          "Modification email inline",
          "Envoi de rappels email (test admin / tous)",
          "Badge admin et chef de mission"
        ],
        "props": [
          "collaborateurs", "setCollaborateurs", "collaborateurChefs", "setCollaborateurChefs",
          "charges", "getChefsOf", "getEquipeOf", "accent", "isAdmin", "userCollaborateur"
        ],
        "modals_used": ["CollaborateurModal"]
      },
      "ClientsPage.jsx": {
        "lines": 820,
        "role": "Gestion des clients — SIREN clé universelle",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Liste des clients avec filtres (cabinet, recherche par nom ou email)",
          "Colonnes: Nom, Type (PM/PP badge), SIREN (monospace), Email (mailto:), NIC, Cabinet, Chef, Charges, API, Actif",
          "Toutes les colonnes triables (clic entête avec flèche ▲/▼)",
          "Ajout/modification de client avec PM/PP + SIREN + siret_complement",
          "Synchronisation Pennylane : firm/v1 (dossiers) + v2/customers (emails) côté serveur",
          "Fusion complète de clients (9 tables FK transférées, gestion doublons UNIQUE)",
          "Assignation chef de mission",
          "Configuration clé API Pennylane par client",
          "Export Excel avec colonnes Type, SIREN, SIRET (NIC), Email"
        ],
        "props": [
          "clients", "setClients", "charges", "setCharges",
          "collaborateurs", "accent", "userCollaborateur"
        ],
        "modals_used": ["ClientModal", "MergeClientModal"]
      },
      "TestsComptablesPage.jsx": {
        "lines": 1269,
        "role": "Tests comptables automatisés",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Sélection client avec recherche + persistance localStorage",
          "Sélection millésime (année fiscale)",
          "Exécution de tests comptables (doublons fournisseurs, relevé fournisseurs)",
          "Affichage des anomalies détectées avec sévérité",
          "Historique des exécutions par client avec chargement auto du dernier test",
          "Export Excel des résultats et des données analysées",
          "Configuration clé API depuis la page avec test de connexion",
          "Marquage fournisseurs 'au relevé' (checkbox persistée en BDD table fournisseurs_releve)",
          "Marquage fournisseurs 'ignorés' (exclus de l'analyse, section pliable)",
          "Calendrier 12 mois par fournisseur au relevé (vert=OK, orange=manquant, rouge=doublon)",
          "Panneau détail mois via DOM pur (zéro re-render React) pour la perf",
          "Liens PDF directs vers les factures Pennylane",
          "Suggestion de marquage au relevé (icône ampoule) si doublons classiques détectés",
          "Bouton restaurer pour fournisseurs masqués",
          "Attestation achats: comptes d'achats personnalisables (défaut 60701, 60702)",
          "Attestation achats: catégories Boissons/Food avec export Word (.docx)",
          "Attestation achats: sélection fournisseurs par coches pour l'attestation Word",
          "Attestation achats: champs adresse client (localStorage) pour en-tête Word"
        ],
        "props": [
          "clients", "collaborateurs", "userCollaborateur",
          "getAccessibleClients", "accent"
        ],
        "access": "Clients avec clé API Pennylane configurée"
      },
      "HonorairesPage.jsx": {
        "lines": 1925,
        "role": "Gestion des honoraires et abonnements Pennylane",
        "typing": "@ts-check + JSDoc",
        "features": [
          "4 onglets: Vue résumé, Augmentation, Audit, Réconciliation",
          "Synchronisation abonnements Pennylane avec prévisualisation (SyncPreviewModal)",
          "Matching intelligent customers/clients (UUID → SIREN → nom)",
          "Filtrage doublons: seuls les customers avec abonnements sont matchés",
          "Vue par client avec totaux par famille (compta, social, juridique, support)",
          "Calcul montant mensuel (conversion annuel/mensuel)",
          "Exclusion des clients inactifs du calcul CA HT",
          "Détail des lignes de facturation par abonnement",
          "Liste clients actifs sans abonnement avec distinction:",
          "  - 'PL sans abo': client lié à Pennylane mais sans abonnement",
          "  - 'Pas dans PL': client non lié à Pennylane",
          "Filtres: cabinet, statut abonnement, recherche nom",
          "Totaux agrégés: comptabilité, social, juridique, support",
          "Onglet Audit: 5 checks (récap familles, non classifiés, écarts fréquence, doublons potentiels, prix social suspects)",
          "Onglet Audit: section 5 prix social suspects + détection clients mixtes (forfait+bulletin)",
          "Onglet Audit: export Excel des alertes (feuille Prix suspects)",
          "Onglet Réconciliation: comparaison live PL↔DB avec écarts HT et %",
          "Réconciliation: filtres, tri, recherche, exclusion France Formalités",
          "Feedback sync (progression, résultat, erreur) visible depuis tous les onglets"
        ],
        "props": [
          "clients", "setClients", "collaborateurs", "accent", "userCollaborateur"
        ],
        "access": "Admin uniquement (is_admin)"
      },
      "SalairesPage.jsx": {
        "lines": 1591,
        "role": "Gestion des salaires collaborateurs - STRICTEMENT ADMIN",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Onglet Salaires: liste salaires actuels avec taux horaire chargé",
          "Onglet Primes: gestion des primes et exceptionnels par année",
          "Onglet Simulations: création scénarios d'augmentation",
          "Historique évolution salaires par collaborateur",
          "Calcul automatique: coût total, taux horaire brut/chargé",
          "Estimation charges patronales (45% par défaut)",
          "Masse salariale globale avec totaux",
          "Export Excel complet",
          "Simulations d'augmentation: % ou montant fixe",
          "Application des simulations: création nouveaux salaires"
        ],
        "props": [
          "collaborateurs", "accent", "userCollaborateur"
        ],
        "access": "Admin uniquement (is_admin) - PROTÉGÉ PAR RLS SUPABASE",
        "security": [
          "Niveau 1: Bouton menu masqué si non-admin",
          "Niveau 2: Composant affiche 'Accès refusé' si non-admin",
          "Niveau 3: RLS Supabase - requêtes retournent 0 lignes si non-admin"
        ]
      },
      "ImpotsTaxesPage.jsx": {
        "lines": 989,
        "role": "Suivi des échéances fiscales",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Grille annuelle par client et type d'échéance",
          "Configuration TVA (jour, périodicité)",
          "Configuration IS, CVAE, CFE, etc.",
          "Cases à cocher fait/pas fait par mois",
          "Sauvegarde automatique dans suivi_echeances",
          "Filtres par chef de mission",
          "Année fiscale sélectionnable"
        ],
        "props": [
          "clients", "collaborateurs", "impotsTaxes", "setImpotsTaxes",
          "suiviEcheances", "accent", "userCollaborateur"
        ],
        "access": "chef_mission ou admin uniquement"
      },
      "RepartitionTVAPage.jsx": {
        "lines": 452,
        "role": "Planification automatique TVA",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Sélection période de planification",
          "Liste des clients avec TVA configurée",
          "Assignation collaborateur par client",
          "Saisie durée estimée par client",
          "Répartition automatique sur jours ouvrés",
          "Validation capacité collaborateurs",
          "Prise en compte jours fériés français"
        ],
        "props": [
          "clients", "collaborateurs", "charges", "setCharges",
          "getEquipeOf", "accent", "userCollaborateur", "impotsTaxes"
        ],
        "access": "chef_mission uniquement"
      },
      "TempsReelsPage.jsx": {
        "lines": 1565,
        "role": "Import des temps réels Pennylane et analyse des écarts",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Import fichier Excel (format Pennylane)",
          "Mapping automatique collaborateurs (par email)",
          "Mapping clients avec création de liaisons",
          "Mode fusion intelligente ou remplacement",
          "Distinction par cabinet (Zerah/Audit Up)",
          "Prévisualisation avant import",
          "Gestion des clients non mappés",
          "Analyse des écarts budgété vs réel avec colonnes triables",
          "Colonne Cabinet (ZG/AU) dans l'analyse des écarts",
          "Colonne Détail travail (commentaires agrégés depuis Excel)",
          "Export Excel des écarts avec toutes les colonnes"
        ],
        "props": [
          "clients", "collaborateurs", "charges", "setCharges", "accent"
        ],
        "access": "chef_mission uniquement"
      }
    },
    "src/components/modals/": {
      "index.js": "Export centralisé: { ThemeModal, CollaborateurModal, ClientModal, MergeClientModal, AddChargeModal, EditChargeModal, ExportModal }",
      "ThemeModal.jsx": {
        "role": "Personnalisation visuelle",
        "typing": "@ts-check + JSDoc",
        "features": ["Sélection gradient de fond", "Images Unsplash par catégorie", "Couleur d'accent (pink, blue, green, etc.)"],
        "tests": "ThemeModal.test.jsx (10 tests)"
      },
      "CollaborateurModal.jsx": {
        "role": "Formulaire collaborateur",
        "typing": "@ts-check + JSDoc",
        "fields": ["nom", "email", "couleur", "actif", "est_chef_mission", "is_admin", "chefs assignés"]
      },
      "ClientModal.jsx": {
        "role": "Formulaire client avec enforcement PM/PP + SIREN",
        "typing": "@ts-check + JSDoc",
        "fields": ["nom", "type_personne (PM/PP)", "siren", "siret_complement", "code_pennylane"],
        "business_rules": [
          "SIREN saisi → auto-force type_personne = PM",
          "Bouton PP désactivé quand SIREN présent",
          "effectiveType = siren.trim() ? 'PM' : typePersonne"
        ]
      },
      "MergeClientModal.jsx": {
        "role": "Fusion complète de clients (transfert de TOUTES les données liées)",
        "typing": "@ts-check + JSDoc",
        "transfers": ["charges", "abonnements", "honoraires_historique", "effectifs_silae", "fournisseurs_releve", "temps_reels"],
        "handles_unique": ["silae_productions (UNIQUE client_id+periode)", "temps_reels (UNIQUE collaborateur_id+client_id+date+cabinet)"],
        "deletes": ["silae_mapping", "tests_comptables_executions"],
        "visibility": "Bouton fusion uniquement pour clients sans cabinet (!client.cabinet)"
      },
      "AddChargeModal.jsx": {
        "role": "Ajout de charge",
        "typing": "@ts-check + JSDoc",
        "fields": ["collaborateur", "client", "date", "heures", "type (budgété/réalisé)", "detail"],
        "features": ["Tri actifs en premier, badge orange 'inactif' sur clients désactivés"]
      },
      "EditChargeModal.jsx": {
        "role": "Modification de charge",
        "typing": "@ts-check + JSDoc",
        "features": ["Modification heures/detail", "Suppression", "Ajout heures réalisées", "Tri actifs en premier, badge orange 'inactif'"]
      },
      "ExportModal.jsx": {
        "role": "Export Excel",
        "typing": "@ts-check + JSDoc",
        "features": ["Sélection date début/fin", "Export format xlsx"]
      }
    },
    "src/components/honoraires/": {
      "SyncPreviewModal.jsx": {
        "role": "Modal de prévisualisation du rapport de synchronisation Pennylane",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Barre résumé: matchés, non matchés, nouveaux abos, variations prix, delta HT",
          "Sections dépliables: matching clients, non matchés, abonnements, variations prix, anomalies",
          "Détection clients inactifs avec abonnements actifs (anomalie error)",
          "Highlight rouge pour variations prix > 20%",
          "Boutons Accepter (vert) / Annuler (gris)",
          "Style dark theme: bg-slate-900, border-slate-700"
        ]
      },
      "AugmentationPanel.jsx": {
        "lines": 1151,
        "role": "Panneau d'analyse des augmentations tarifaires avec sauvegarde tarifs 2025+2026",
        "typing": "@ts-check + JSDoc",
        "features": [
          "Calcul augmentation par client et par axe (8 axes métier)",
          "Exclusion des clients inactifs du calcul CA HT",
          "Sauvegarde en 2 étapes : baseline 2025 (ancien prix) + augmentés 2026 (nouveau prix)",
          "Progress bar 0-50% baseline, 50-100% augmentation avec libellé dynamique",
          "Verrouillage prix individuels par ligne",
          "DiagnosticModal: analyse anomalies (7 patterns) avant augmentation",
          "Export Excel des augmentations (multi-feuilles)"
        ]
      },
      "RestructurationPanel.jsx": {
        "lines": 310,
        "role": "Phase 2 — UI de restructuration des abonnements PL (séparation fixe/variable)",
        "features": [
          "Mode 'Un client (test)' avec recherche par nom/SIREN/UUID",
          "Mode 'Tous les clients' avec batch analysis et progress",
          "KPI cards : clients analysés, avec variables, lignes fixes, abos à supprimer",
          "Vue arborescente : client → abonnement → lignes (expand/collapse)",
          "Badge décision par abo : Inchangé (vert), Retirer variable (orange), Supprimer abo (rouge)",
          "Lignes fixes en vert avec prix 2026, lignes variables en rouge",
          "Export Excel restructuration (4 onglets)"
        ]
      },
      "FacturationVariablePanel.jsx": {
        "lines": 508,
        "role": "Phase 3 — UI de facturation variable mensuelle (Silae → Excel PL brouillons)",
        "features": [
          "Mode 'Un client (test)' avec recherche par nom/SIREN",
          "Mode 'Tous les clients' avec batch generation et progress",
          "Sync produits PL (API /products) avant chaque export",
          "Export Excel 1 fichier PAR CABINET (AUP/ZF) au format PL brouillons",
          "Nommage fichiers : 'AUP Janvier 26 a importer dans PL.xlsx'",
          "Période ajoutée au nom produit : 'Etablissement de bulletin de salaire Janvier 26'",
          "KPI cards : clients, avec/sans Silae, complets, total HT",
          "Vue détaillée par client avec lignes (source Silae/Manuel, qté, PU, montant)"
        ],
        "props": ["clients", "accent", "filterCabinet", "apiKeysMap"]
      },
      "DiagnosticModal.jsx": {
        "lines": 343,
        "role": "Modal de diagnostic des anomalies avant augmentation",
        "typing": "@ts-check + JSDoc",
        "features": [
          "7 patterns de détection: doublons, écarts fréquence, accessoires sans bulletin, etc.",
          "Section prix social suspects (Pattern 7): bulletin < 1€, > 30€, forfait < 30€",
          "Affichage par sévérité (error/warning) avec icônes colorées"
        ]
      }
    },
    "src/utils/": {
      "dateUtils.js": {
        "typing": "@ts-check + JSDoc",
        "exports": [
          "formatDateToYMD(date) - Date -> 'YYYY-MM-DD'",
          "parseDateString(str) - 'YYYY-MM-DD' -> Date locale"
        ],
        "tests": "dateUtils.test.js (10 tests)"
      },
      "testsComptables/": {
        "description": "Module de tests comptables automatisés",
        "files": {
          "index.js": "Export centralisé des fonctions de test",
          "pennylaneClientApi.js": {
            "role": "Client API Pennylane v2",
            "exports": [
              "callPennylaneAPI(apiKey, endpoint, params) - Appel générique via proxy",
              "getFEC(apiKey, millesime) - Récupère le FEC d'un exercice",
              "getFECByAccounts(apiKey, millesime, comptePrefixes) - Version optimisée du FEC filtré par comptes",
              "getSupplierInvoices(apiKey, millesime) - Factures fournisseurs",
              "getCustomerInvoices(apiKey, millesime) - Factures clients",
              "getBankTransactions(apiKey, millesime) - Opérations bancaires",
              "getChartOfAccounts(apiKey) - Plan comptable",
              "getSuppliers(apiKey) - Liste fournisseurs",
              "getLedgerAccounts(apiKey) - Tous les comptes du plan comptable",
              "testConnection(apiKey) - Test de validité de la clé API"
            ]
          },
          "testRunner.js": {
            "role": "Orchestrateur d'exécution des tests",
            "exports": [
              "runTest(params) - Exécute un test et sauvegarde les résultats",
              "getExecutionHistory(clientId) - Historique des exécutions",
              "getExecutionResults(executionId) - Résultats détaillés",
              "markAsProcessed(resultatId, collaborateurId) - Marquer comme traité",
              "getTestDefinitions() - Récupère les définitions de tests depuis la BDD"
            ]
          },
          "exportResults.js": {
            "role": "Export Excel des résultats de tests",
            "exports": [
              "exportTestResults({execution, resultats, client, test}) - Export anomalies en xlsx",
              "exportHistorique({executions, client}) - Export historique des exécutions",
              "exportDonneesAnalysees({donneesAnalysees, client, test, millesime}) - Export données analysées (même sans anomalies)",
              "exportAttestationWord({donneesAnalysees, client, millesime, nomSociete, adresse, cpVille, selectedFournisseurs}) - Export attestation Word (.docx)"
            ]
          },
          "tests/": {
            "doublonsFournisseurs.js": "Détection doublons comptes 401 (similarité Levenshtein + mots communs significatifs)",
            "doubleSaisie.js": {
              "role": "Relevé fournisseurs - Suivi des fournisseurs avec 3 modes",
              "code": "double_saisie",
              "nom_affiche": "Relevé fournisseurs",
              "requiredData": "supplierInvoices (API /supplier_invoices)",
              "modes": {
                "fournisseur_au_releve": "Calendrier 12 mois: alerte doublon_releve (2+ factures/mois), alerte releve_manquant (0 facture/mois passé)",
                "fournisseur_normal": "Doublons classiques: montants égaux, récent > ancien, ou fichier relevé détecté, dans la tolérance (défaut 31j)",
                "fournisseur_ignore": "Exclu de l'analyse, listé à part"
              },
              "tests": "doubleSaisie.test.js (14 tests)"
            },
            "attestationAchats.js": {
              "role": "Attestation achats fournisseurs liste limitative",
              "code": "attestation_achats",
              "nom_affiche": "Attestation achats fournisseurs",
              "requiredData": "fec (API /ledger_entry_lines via getFECByAccounts)",
              "description": "Génère attestation HT par fournisseur, groupé par catégorie (Boissons, Food) avec détail vérification FEC et export Word",
              "options": {
                "comptesAchats": "Préfixes comptes à filtrer (défaut: ['60701','60702'])"
              },
              "output": {
                "excel_attestation": "Feuille récapitulatif par fournisseur/catégorie avec sous-totaux HT",
                "excel_verification": "Feuille détail FEC (Débit/Crédit/Solde/Produits)",
                "word_attestation": "Document Word (.docx) AUDIT UP avec sélection fournisseurs"
              }
            },
            "index.js": "Registry des tests disponibles (testsRegistry, getTest, getAllTests, getTestsByCategory)"
          }
        }
      },
      "honoraires/": {
        "description": "Module de gestion des honoraires et abonnements Pennylane",
        "files": {
          "index.js": "Export centralisé du module honoraires (voir détail dans files/index.js)",
          "pennylaneCustomersApi.js": {
            "role": "Client API Pennylane v2 pour customers et abonnements",
            "exports": [
              "fetchAllCustomers(apiKey, companyId?) - Récupère tous les customers (pagination, X-Company-Id optionnel)",
              "fetchAllSubscriptions(apiKey, companyId?) - Récupère tous les abonnements (X-Company-Id optionnel)",
              "fetchAllDataForSync(apiKey, onProgress, companyId?) - Récupère customers + abonnements",
              "getSubscriptionInvoiceLines(apiKey, subscriptionId, companyId?) - Lignes de facturation",
              "testConnection(apiKey) - Test de validité de la clé API"
            ],
            "x_company_id": "Header X-Company-Id passé au proxy pour isoler les données par cabinet Pennylane"
          },
          "syncPreview.js": {
            "role": "Prévisualisation et commit sync Pennylane (preview → modal → commit)",
            "exports": [
              "previewSync(supabase, apiKey, cabinet, onProgress) - Preview diff complet sans écrire en base",
              "commitSync(supabase, report, cabinet, onProgress) - Applique les changements du preview + historique prix"
            ],
            "matching_strategy": [
              "1. Par pennylane_customer_id (UUID)",
              "2. Par SIREN (reg_no) — CLÉ UNIVERSELLE",
              "3. Par nom normalisé (exact)",
              "4. Par nom sans suffixes juridiques",
              "5. Par nom normalisé (contient/partiel)",
              "6. Par nom sans suffixes (contient/partiel)",
              "Chaque match retourne un level pour diagnostic (uuid/siren/name_exact/name_clean/name_partial/name_clean_partial)"
            ],
            "anomaly_detection": [
              "Variation prix > 20%",
              "Changement de cabinet",
              "Clients inactifs avec abonnements actifs",
              "Matches faibles (name_partial, name_clean_partial)"
            ],
            "tests": "syncPreview.test.js (47 tests)"
          },
          "syncHonoraires.js": {
            "role": "Service de synchronisation honoraires (legacy, utilisé par commitSync)",
            "exports": [
              "syncCustomersAndSubscriptions(supabase, apiKey, cabinet, onProgress) - Sync complète",
              "getHonorairesResume(supabase, clientId, options) - Résumé des honoraires (option includeStopped)",
              "normalizeString(str) - Normalise une chaîne pour comparaison",
              "removeJuridicalSuffixes(name) - Supprime suffixes juridiques",
              "matchCustomerToClient(customer, clients) - Match customer vers client local",
              "getFamilleFromLabel(label, produits) - Détermine la famille d'un produit"
            ],
            "matching_strategy": [
              "1. Par pennylane_customer_id existant (UUID)",
              "2. Par SIREN (reg_no) — CLÉ UNIVERSELLE",
              "3. Par nom normalisé (exact)",
              "4. Par nom sans suffixes juridiques (SARL, SAS, etc.)",
              "5. Par nom normalisé (contient)",
              "6. Par nom sans suffixes (contient)",
              "IMPORTANT: Seuls les customers avec abonnements sont matchés (évite doublons)"
            ],
            "select_query": "id, nom, pennylane_customer_id, code_silae, cabinet, siren"
          },
          "silaeService.js": {
            "role": "Import Excel Silae et matching SIREN",
            "exports": [
              "importSilaeData(supabase, excelBuffer, cabinet, onProgress) - Parse Excel Silae"
            ],
            "matching_strategy": [
              "1. Par mapping BDD (silae_mapping table)",
              "2. Par SIREN (colonne C Excel = client.siren) — CLÉ UNIVERSELLE",
              "3. Par code_silae",
              "4. Par nom exact",
              "5. Par nom partiel"
            ]
          },
          "classificationAxes.js": {
            "lines": 370,
            "role": "Classification des lignes de facturation en 8 axes d'augmentation",
            "exports": [
              "AXE_DEFINITIONS - Définitions des 8 axes (compta_mensuelle, bilan, pl, social_forfait, social_bulletin, accessoires_social, juridique, support)",
              "AXE_KEYS - Liste ordonnée des clés d'axes",
              "classifierLigne(ligne, modeFacturationSocial) - Classifie une ligne PAR LIGNE (label, qté, prix unitaire)",
              "getMultiplicateurAccessoire(label) - Multiplicateur accessoire (1× ou 2× bulletin)",
              "detectModeFacturationSocial(lignes) - Détecte mode dominant (forfait/reel) pour AFFICHAGE uniquement",
              "classifierToutesLesLignes(honoraires, clients) - Classifie toutes les lignes + détecte modes"
            ],
            "classification_logic": [
              "Classification PAR LIGNE (pas par mode client global) — corrige écart CA 2.66M→2.22M",
              "Priorité: bilan → P&L → compta → accessoires → social (label→qté→prix) → juridique → support",
              "Social: label 'bulletin' → social_bulletin, label 'forfait' → social_forfait, qté > 1 → bulletin, prix < 30€ → bulletin, défaut → forfait",
              "Accessoires: coffre-fort, publi-postage, entrée/sortie, extra, modification de bulletin"
            ],
            "tests": "classificationAxes.test.js (46 tests)"
          },
          "calculsAugmentation.js": {
            "lines": 530,
            "role": "Calculs d'augmentation tarifaire par axe et par client",
            "exports": [
              "calculerAugmentationParClient(lignesClassifiees, augmentations, silaeData) - Calcul nouveau tarif par axe",
              "calculerTotaux(resultatsParClient) - Agrégation totaux CA actuel/nouveau/delta"
            ]
          },
          "diagnosticHonoraires.js": {
            "lines": 322,
            "role": "Diagnostic des anomalies dans les données honoraires",
            "exports": [
              "diagnostiquerHonoraires(lignesClassifiees) - Analyse 7 patterns d'anomalies"
            ],
            "patterns": [
              "1. Doublons potentiels (lignes identiques même client)",
              "2. Écarts de fréquence (annuel vs mensuel)",
              "3. Accessoires sans bulletin associé",
              "4. Lignes non classifiées",
              "5. Prix unitaire anormal (< 1€ ou > 10000€)",
              "6. Clients avec beaucoup de lignes (> 10)",
              "7. Prix social suspects (bulletin < 1€, > 30€, forfait < 30€)"
            ]
          },
          "auditHonoraires.js": {
            "lines": 471,
            "role": "Audit des données honoraires avec requêtes Supabase directes",
            "exports": [
              "runAuditHonoraires(supabase) - Exécute les 5 checks d'audit"
            ],
            "checks": [
              "1. Récapitulatif par famille (compta, social, juridique, support)",
              "2. Lignes non classifiées (axe = null)",
              "3. Écarts de fréquence entre lignes d'un même abonnement",
              "4. Doublons potentiels (même label, même client, même montant)",
              "5. Prix social suspects + détection clients mixtes (forfait+bulletin)"
            ]
          },
          "tarifsReferenceService.js": {
            "lines": 271,
            "role": "Service CRUD pour les tarifs de référence (table tarifs_reference) — baseline 2025 + augmentés 2026",
            "exports": [
              "sauvegarderTarifsBaseline(supabase, resultats, dateEffet, source, onProgress) - Sauvegarde tarifs AVANT augmentation (ancien_prix_unitaire_ht)",
              "sauvegarderTarifsReference(supabase, resultats, dateEffet, source, onProgress) - Sauvegarde tarifs APRÈS augmentation (nouveau_prix_unitaire_ht)",
              "chargerTarifsReference(supabase, options) - Charge tarifs avec filtres (cabinet, type, dateEffet)",
              "getDatesEffetDisponibles(supabase) - Dates d'effet distinctes pour sélecteur",
              "chargerProduitsPennylane(supabase, cabinet) - Mapping produits Pennylane par cabinet",
              "supprimerTarifsReference(supabase, dateEffet) - Supprime tarifs pour une date d'effet"
            ],
            "two_step_save": "Baseline 2025 (ancien_prix) + Augmentation 2026 (nouveau_prix) en 2 passes avec progress callback",
            "upsert_strategy": "onConflict: 'client_id,label,date_effet' — permet 2 versions par produit",
            "type_recurrence_rule": "social_bulletin + accessoires_social → 'variable', tout le reste → 'fixe'",
            "tests": "tarifsReferenceService.test.js (19 tests)"
          },
          "reconciliation.js": {
            "lines": 287,
            "role": "Réconciliation Pennylane ↔ Base locale (comparaison live)",
            "exports": [
              "reconcilierDonnees(supabase, cabinets, onProgress) - Compare API PL live vs DB, retourne écarts HT et %",
              "matchCustomerToClient(customer, clients, matchedClientIds) - Matching STRICT: SIREN first, UUID fallback",
              "isFranceFormalites(name) - Exclut les customers France Formalités (pas d'abo honoraires)",
              "MATCH_LEVEL_LABELS - Labels des niveaux de match (uuid, siren)"
            ],
            "matching_strategy": [
              "MATCHING STRICT UNIQUEMENT (pas de matching par nom)",
              "1. Par SIREN (prioritaire — identifiant officiel INSEE, 9 chiffres)",
              "2. Par pennylane_customer_id (UUID — fallback, peut être mal assigné)",
              "Déduplication: un client local ne peut être matché qu'une seule fois",
              "SIREN ambigu (multi-établissements): disambiguation par UUID"
            ],
            "exclusions": "Customers France Formalités (nom finissant par ' FF' ou contenant 'FRANCE FORMAL')",
            "tests": "reconciliation.test.js (20 tests)"
          },
          "exportAugmentation.js": {
            "lines": 619,
            "role": "Export Excel multi-feuilles des augmentations tarifaires",
            "exports": [
              "exportAugmentationExcel(data) - Génère fichier XLSX (feuilles: Résumé, Détail par client, Par axe, Prix suspects)"
            ]
          },
          "subscriptionRestructuration.js": {
            "lines": 220,
            "role": "Phase 2 — Analyse et plan de restructuration des abonnements PL (séparation fixe/variable)",
            "exports": [
              "analyserClient({clientId, supabase}) — Analyse un client : charge abonnements + tarifs 2026, sépare fixe/variable, détermine décision par abo",
              "analyserTousLesClients({supabase, cabinet, onProgress}) — Analyse batch de tous les clients avec tarifs 2026",
              "calculerStatistiques(plans) — Agrège KPIs globaux et par cabinet"
            ],
            "decisions_par_abonnement": [
              "'inchange' : aucune ligne variable → juste mettre à jour les prix",
              "'a_modifier' : mix fixe/variable → garder fixe, supprimer variable",
              "'a_supprimer' : 100% variable → supprimer l'abonnement entier"
            ],
            "tests": "subscriptionRestructuration.test.js (12 tests)"
          },
          "exportRestructuration.js": {
            "lines": 490,
            "role": "Export Excel Phase 2 avec 5 onglets : Résumé, Import PL AUP, Import PL ZF, A supprimer, Détail croisé",
            "exports": [
              "exportRestructurationExcel({plans, stats, singleClient}) — Génère fichier XLSX de restructuration"
            ],
            "sheets": [
              "Résumé : KPIs + tableau par cabinet",
              "Import PL AUP : format import Pennylane — abonnements fixes Audit Up avec prix 2026",
              "Import PL ZF : format import Pennylane — abonnements fixes Zerah Fiduciaire avec prix 2026",
              "A SUPPRIMER : liste des lignes variables à retirer de PL (header rouge)",
              "Détail croisé : vue complète par client × abonnement × ligne × décision"
            ],
            "split_cabinet": "Génère 1 onglet Import PL par cabinet (AUP/ZF) — trié par nom client",
            "tests": "exportRestructuration.test.js (32 tests)"
          },
          "facturationVariableService.js": {
            "lines": 632,
            "role": "Phase 3 — Service de facturation variable mensuelle (croisement Silae × tarifs de référence)",
            "exports": [
              "genererFacturationVariable({supabase, periode, dateEffet, cabinet}) — Génère la facturation variable pour tous les clients",
              "genererFacturationClient({supabase, clientId, periode, dateEffet}) — Génère la facturation pour un client",
              "getPeriodesDisponibles(supabase) — Retourne les périodes Silae importées",
              "getDatesEffetVariables(supabase) — Retourne les dates d'effet des tarifs de référence",
              "syncProduitsPennylane({supabase, cabinet, plProducts}) — Sync produits PL API → table produits_pennylane"
            ],
            "data_flow": [
              "1. Charge silae_productions pour la période sélectionnée",
              "2. Charge tarifs_reference pour la date d'effet (prix unitaires)",
              "3. Charge produits_pennylane (UUIDs pour identifiant produit PL)",
              "4. Croise : pour chaque client, pour chaque produit variable, calcule qté × PU HT",
              "5. Produits VARIABLES uniquement (type_recurrence='variable'), les FIXES restent en abonnement PL"
            ]
          },
          "exportFacturationVariable.js": {
            "lines": 224,
            "role": "Phase 3 — Export Excel au format STRICT d'import PL brouillons (1 fichier par cabinet)",
            "exports": [
              "exportFacturationVariableExcel({resultat, client, periode}) — Génère 1 fichier XLSX par cabinet"
            ],
            "format_excel": {
              "sheet_name": "Feuil1",
              "columns": "A:Raison sociale, B:SIREN(nombre), C:UUID produit, D:Nom produit+période, E:vide, F:Quantité, G:unité, H:PU HT, I:TVA(0.00%), J:Prestations de services, K:Date serial(m/d/yy), L:vide",
              "naming": "'{AUP|ZF} {Mois} {AA} a importer dans PL.xlsx'",
              "rules": [
                "Cellules construites manuellement (t/v/z) pour contrôle exact des types",
                "SIREN en nombre (t:n), pas texte",
                "TVA en nombre 0.2 avec format z:'0.00%'",
                "Date en serial Excel avec format z:'m/d/yy'",
                "Colonnes E et L absentes (pas de cellule créée)",
                "Lignes manuelles exclues (quantite null/undefined)",
                "Période ajoutée au nom produit : 'Janvier 26'"
              ]
            }
          },
          "index.js": {
            "lines": 109,
            "role": "Export centralisé du module honoraires",
            "exports": [
              "syncCustomersAndSubscriptions, getHonorairesResume, testConnection, fetchAllDataForSync",
              "previewSync, commitSync, reconcilierDonnees",
              "classifierLigne, classifierToutesLesLignes, detectModeFacturationSocial",
              "AXE_DEFINITIONS, AXE_KEYS",
              "calculerAugmentationLigne, calculerAugmentationGlobale, calculerTotauxResume, creerParametresDefaut, getCoeffAnnualisation",
              "genererDiagnostic, auditAbonnements",
              "sauvegarderTarifsBaseline, sauvegarderTarifsReference, chargerTarifsReference, getDatesEffetDisponibles, chargerProduitsPennylane, supprimerTarifsReference",
              "analyserClient, analyserTousLesClients, calculerStatistiques",
              "exportAugmentationExcel, exportDiagnosticExcel, exportRestructurationExcel",
              "genererFacturationVariable, genererFacturationClient, getPeriodesDisponibles, getDatesEffetVariables, syncProduitsPennylane, getAllProducts",
              "exportFacturationVariableExcel"
            ]
          }
        }
      },
      "salaires/": {
        "description": "Module de gestion des salaires - ACCES ADMIN UNIQUEMENT (RLS)",
        "files": {
          "index.js": "Export centralisé de tous les services et fonctions de calcul",
          "salairesService.js": {
            "role": "CRUD salaires collaborateurs",
            "exports": [
              "getSalairesActuels(supabase) - Salaire actuel de chaque collaborateur",
              "getHistoriqueSalaires(supabase, collaborateurId) - Historique évolution",
              "getSalaireCollaborateur(supabase, collaborateurId) - Salaire actuel d'un collab",
              "createSalaire(supabase, salaire) - Créer nouvelle entrée",
              "updateSalaire(supabase, id, updates) - Modifier",
              "deleteSalaire(supabase, id) - Supprimer"
            ]
          },
          "primesService.js": {
            "role": "CRUD primes et exceptionnels",
            "exports": [
              "getPrimes(supabase, annee?) - Liste des primes",
              "getPrimesCollaborateur(supabase, collaborateurId, annee?) - Primes d'un collab",
              "createPrime(supabase, prime) - Créer prime",
              "updatePrime(supabase, id, updates) - Modifier",
              "deletePrime(supabase, id) - Supprimer",
              "TYPES_PRIMES - Liste des types de primes disponibles"
            ]
          },
          "simulationsService.js": {
            "role": "Gestion des simulations d'augmentation",
            "exports": [
              "getSimulations(supabase, statut?) - Liste simulations",
              "getSimulation(supabase, id) - Détail avec lignes",
              "createSimulation(supabase, simulation) - Créer simulation",
              "updateSimulation(supabase, id, updates) - Modifier",
              "deleteSimulation(supabase, id) - Supprimer",
              "appliquerSimulation(supabase, id, validatedBy) - Créer les nouveaux salaires",
              "upsertLigneSimulation(supabase, ligne) - Ajouter/modifier ligne"
            ]
          },
          "calculsSalaires.js": {
            "role": "Fonctions de calcul pures",
            "exports": [
              "calculerCoutTotal(brut, charges) - Coût employeur",
              "calculerTauxHoraireBrut(brutAnnuel, heures) - Taux horaire brut",
              "calculerTauxHoraireCharge(brut, charges, heures) - Taux horaire chargé",
              "calculerAugmentation(salaire, valeur, type) - Nouveau salaire après augmentation",
              "estimerChargesPatronales(brut, taux?) - Estimation charges (45% défaut)",
              "calculerMasseSalariale(salaires) - Totaux brut/charges/coût",
              "formatMontant(montant) - Formatage euros",
              "formatTauxHoraire(taux) - Formatage €/h",
              "simulerAugmentationGlobale(salaires, pourcentage) - Simulation augmentation collective",
              "calculerEvolution(ancien, nouveau) - Calcul % évolution",
              "HEURES_ANNUELLES_LEGALES - 1607h",
              "TAUX_CHARGES_PATRONALES_DEFAUT - 0.45 (45%)"
            ]
          }
        }
      },
      "businessLogic.js": {
        "typing": "@ts-check + JSDoc",
        "role": "Fonctions de logique métier extraites pour testabilité",
        "exports": [
          "getChefsOf(collaborateurId, collaborateurChefs, collaborateurs) - Obtenir les chefs d'un collaborateur",
          "getEquipeOf(chefId, collaborateurChefs, collaborateurs) - Obtenir l'équipe d'un chef",
          "getAccessibleClients(collaborateur, clients, collaborateurChefs, collaborateurs) - Clients accessibles selon permissions",
          "canEditCharge(userCollaborateur, chargeCollaborateurId, ...) - Vérifier droit de modification",
          "getVisibleCharges(userCollaborateur, charges, ...) - Charges visibles selon permissions",
          "getChargesForDate(charges, collaborateurId, dateStr) - Filtrer charges par date",
          "getTotalHoursForDate(charges, collaborateurId, dateStr) - Total heures par date",
          "getAggregatedByClient(charges, clients, collaborateurId, dateStr) - Heures agrégées par client",
          "getVisibleCollaborateurs(userCollaborateur, activeCollaborateurs, collaborateurChefs) - Collaborateurs visibles selon droits",
          "hasBudgetForDate(charges, collaborateurId, dateStr) - Vérifie si budget existe",
          "hasTempsReelsForDate(tempsReels, collaborateurId, dateStr) - Vérifie si temps réels saisis",
          "isJourOuvre(date) - Vérifie si jour ouvré (lundi-vendredi)",
          "getWeekDays(currentDate, weekOffset) - Calcule les 7 jours d'une semaine",
          "getWeekTotal(charges, collaborateurId, weekDays, formatDateToYMD) - Total heures sur semaine",
          "countAlerts(collaborateurs, charges, tempsReels, ...) - Compte les alertes collaborateurs"
        ],
        "tests": [
          "businessLogic.test.js (22 tests unitaires)",
          "businessLogic.scenarios.test.js (25 tests scénarios métier)",
          "calendarLogic.test.js (35 tests fonctions calendrier)"
        ]
      }
    },
    "src/constants/": {
      "theme.js": {
        "typing": "@ts-check + JSDoc",
        "exports": [
          "GRADIENT_THEMES - Liste des dégradés disponibles",
          "ACCENT_COLORS - Couleurs d'accent (pink, blue, green, purple, orange)",
          "UNSPLASH_CATEGORIES - Catégories d'images (nature, city, abstract, etc.)",
          "UNSPLASH_ACCESS_KEY - Clé API Unsplash"
        ],
        "tests": "theme.test.js (16 tests)"
      }
    },
    "src/test/": {
      "setup.js": "Configuration jest-dom pour les tests"
    }
  },
  "testing": {
    "framework": "Vitest + React Testing Library",
    "config_file": "vitest.config.js",
    "commands": {
      "npm test": "Lance les tests en mode watch",
      "npm run test:run": "Lance les tests une fois",
      "npm run test:coverage": "Lance les tests avec rapport de couverture"
    },
    "test_files": {
      "src/utils/dateUtils.test.js": {
        "tests": 10,
        "coverage": "formatDateToYMD, parseDateString"
      },
      "src/utils/businessLogic.test.js": {
        "tests": 22,
        "coverage": "getChefsOf, getEquipeOf, getAccessibleClients, canEditCharge, getVisibleCharges"
      },
      "src/utils/businessLogic.scenarios.test.js": {
        "tests": 25,
        "coverage": "Scénarios métier réalistes cabinet comptable (hiérarchie, permissions, cas limites)"
      },
      "src/constants/theme.test.js": {
        "tests": 16,
        "coverage": "GRADIENT_THEMES, ACCENT_COLORS, UNSPLASH_CATEGORIES"
      },
      "src/components/pages/AuthPage.test.jsx": {
        "tests": 13,
        "coverage": "Rendu formulaires login/register/forgot, navigation"
      },
      "src/components/modals/ThemeModal.test.jsx": {
        "tests": 10,
        "coverage": "Rendu, onglets, sélection thèmes et couleurs"
      },
      "src/utils/calendarLogic.test.js": {
        "tests": 35,
        "coverage": "Fonctions calendrier: getChargesForDate, getTotalHoursForDate, getAggregatedByClient, getVisibleCollaborateurs, hasBudgetForDate, hasTempsReelsForDate, isJourOuvre, getWeekDays, getWeekTotal, countAlerts"
      },
      "src/utils/honoraires/syncHonoraires.test.js": {
        "tests": 35,
        "coverage": "normalizeString, removeJuridicalSuffixes, matchCustomerToClient, getFamilleFromLabel, filtrage customers sans abonnement, cas réels doublons cabinet, faux positifs par nom, SIREN ambigu multi-établissements"
      },
      "src/utils/honoraires/syncPreview.test.js": {
        "tests": 47,
        "coverage": "matchCustomerToClientWithLevel (UUID/SIREN/nom/nettoyé/partiel), SIREN ambigu multi-établissements, séparation actifs/inactifs, detectInactiveWithSubscriptions, génération anomalies, détection matches faibles, enrichissement emails par SIREN, extraction email depuis customer Pennylane"
      },
      "src/utils/honoraires/reconciliation.test.js": {
        "tests": 20,
        "coverage": "isFranceFormalites (exclusion FF), matching strict SIREN+UUID (pas de nom), faux positifs documentés, SIREN ambigu multi-établissements avec déduplication, UUID legacy vs UUID réel"
      },
      "src/utils/honoraires/tarifsReferenceService.test.js": {
        "tests": 19,
        "coverage": "sauvegarderTarifsBaseline (ancien prix, exclu, sans axe, erreurs, type_recurrence, progress), sauvegarderTarifsReference (nouveau prix, exclu, sans axe, upsert onConflict), baseline vs reference prix différents, getTypeRecurrence 8 axes"
      },
      "src/utils/honoraires/subscriptionRestructuration.test.js": {
        "tests": 12,
        "coverage": "analyserClient HFC INVEST (séparation fixe/variable, totaux HT, décision inchangé/a_supprimer, prix 2026, action supprimer, axes variables, client sans abonnements, abonnement mixte a_modifier), calculerStatistiques (agrégation, par cabinet, tableau vide)"
      },
      "src/utils/honoraires/exportRestructuration.test.js": {
        "tests": 32,
        "coverage": "Structure générale (5 onglets 2 cabinets, 4 onglets 1 cabinet, nommage fichier, singleClient), split AUP/ZF (séparation clients, tri alphabétique, abo sans lignes fixes ignoré), format colonnes PL 2026 (10 fixes, 4 cols/ligne produit, multi-lignes), données ligne PL 2026 (prix HT direct, métadonnées 10 cols, SIREN), matching UUID produits (mission comptable, P&L, RDV, isolation cabinet, sans produits), formatDatePennylane (ISO→dd/mm/yyyy, ISO+T, passthrough), onglet A SUPPRIMER, Détail croisé, cas limites (0 abos, plans vide, yearly, prix symbolique, colonnes vides padding)"
      },
      "src/utils/honoraires/facturationVariable.test.js": {
        "tests": 59,
        "coverage": "Export Excel PL brouillons (split cabinet AUP/ZF, nommage fichiers, période dans nom produit, format cellules strict: SIREN nombre, TVA 0.00%, date serial m/d/yy, colonnes E/L absentes, exclusion lignes manuelles, 12 headers, feuille Feuil1), serial dates Excel (jan/fév/mar/déc), formaterPeriodeFr 12 mois, BK BAGNEUX données référence (6 produits, 5 auto + 1 manuel, total HT 746.20), mapping colonne_silae, calcul PU TTC, normalisation labels, syncProduitsPennylane (import, vide, null)"
      },
      "src/utils/testsComptables/tests/doubleSaisie.test.js": {
        "tests": 14,
        "coverage": "Métadonnées test, doublons classiques (montant récent > ancien, tolérance jours), doublons relevé (2+ factures/mois), extraction nom fournisseur, statistiques, filtrage factures invalides"
      },
      "src/utils/salaires/calculsSalaires.test.js": {
        "tests": 54,
        "coverage": "Constantes, calculerCoutTotal, calculerTauxHoraireBrut, calculerTauxHoraireCharge, calculerAugmentation, estimerChargesPatronales, calculerMasseSalariale, simulerAugmentationGlobale, formatMontant, formatTauxHoraire, calculerEvolution, scénarios métier rentabilité"
      }
    },
    "total_tests": 536
  },
  "database_tables": {
    "collaborateurs": {
      "description": "Utilisateurs du système (collaborateurs du cabinet)",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "nom": "TEXT NOT NULL",
        "email": "TEXT UNIQUE",
        "actif": "BOOLEAN DEFAULT true",
        "est_chef_mission": "BOOLEAN DEFAULT false",
        "is_admin": "BOOLEAN DEFAULT false",
        "couleur": "TEXT (code hex pour affichage calendrier)"
      }
    },
    "collaborateur_chefs": {
      "description": "Relation N-N entre collaborateurs et leurs chefs de mission",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "chef_id": "INTEGER REFERENCES collaborateurs(id)"
      },
      "note": "Un collaborateur peut avoir plusieurs chefs, un chef peut avoir plusieurs collaborateurs"
    },
    "clients": {
      "description": "Clients du cabinet — SIREN = CLÉ UNIVERSELLE de matching",
      "business_rule": "RÈGLE MÉTIER ABSOLUE : si SIREN renseigné → TOUJOURS type_personne = PM",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "nom": "TEXT NOT NULL",
        "actif": "BOOLEAN DEFAULT true",
        "cabinet": "TEXT ('Zerah Fiduciaire' ou 'Audit Up')",
        "chef_mission_id": "INTEGER REFERENCES collaborateurs(id)",
        "type_personne": "TEXT CHECK (PM ou PP) — PM=Personne Morale, PP=Personne Physique",
        "siren": "TEXT (9 chiffres — CLÉ UNIVERSELLE de matching entre Pennylane, Silae, etc.)",
        "siret_complement": "TEXT (NIC 5 chiffres — SIRET = SIREN + NIC pour distinguer les établissements)",
        "pennylane_id": "INTEGER (ID dossier firm/v1/companies)",
        "pennylane_customer_id": "TEXT (UUID v2/customers = external_reference)",
        "code_pennylane": "TEXT (code dossier Pennylane ex: CHQOTMLUDT)",
        "code_silae": "TEXT (code client Silae pour mapping social)",
        "pennylane_client_api_key": "TEXT (clé API Pennylane du client pour tests comptables)",
        "email": "TEXT (email contact synchronisé depuis Pennylane v2/customers)",
        "mode_facturation_social": "TEXT ('forfait' ou 'reel')"
      },
      "indexes": {
        "idx_clients_unique_siren_nic": "UNIQUE(siren, COALESCE(siret_complement, '')) WHERE siren IS NOT NULL AND actif = true",
        "idx_clients_siren": "INDEX ON siren WHERE siren IS NOT NULL",
        "idx_clients_pennylane": "UNIQUE(pennylane_id, cabinet) WHERE pennylane_id IS NOT NULL"
      },
      "stats_2026_02": "166 clients actifs, 165 PM + 1 PP (MICHEL MALRIC), 0 SIREN partagé (sauf RELAIS CHRISTINE/SAINT JAMES = SIRET différents)",
      "inactive_clients_behavior": "Inclus dans getAccessibleClients (saisie temps bilans), exclus du CA HT honoraires (HonorairesPage + AugmentationPanel)"
    },
    "charges": {
      "description": "Charges de travail planifiées et réalisées",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "client_id": "INTEGER REFERENCES clients(id)",
        "date_charge": "DATE NOT NULL",
        "heures": "DECIMAL (heures budgétées)",
        "heures_realisees": "DECIMAL DEFAULT 0 (heures réellement passées)",
        "type": "TEXT ('budgété' ou 'réalisé')",
        "detail": "TEXT (description de la tâche: 'Bilan', 'TVA', 'Paie', etc.)"
      }
    },
    "impots_taxes": {
      "description": "Configuration des échéances fiscales par client et année",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id)",
        "annee_fiscale": "INTEGER (ex: 2025)",
        "tva_jour": "INTEGER (jour du mois pour TVA, ex: 19)",
        "tva_periodicite": "TEXT ('mensuelle', 'trimestrielle', 'annuelle')",
        "is_jour": "INTEGER (jour pour IS)",
        "is_periodicite": "TEXT",
        "cvae_jour": "INTEGER",
        "cfe_jour": "INTEGER",
        "das2_jour": "INTEGER",
        "liasse_jour": "INTEGER",
        "...": "autres champs pour chaque type d'impôt"
      }
    },
    "suivi_echeances": {
      "description": "Suivi de réalisation des échéances fiscales",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id)",
        "type_echeance": "TEXT ('tva', 'is', 'cvae', etc.)",
        "mois": "INTEGER (1-12)",
        "annee": "INTEGER",
        "fait": "BOOLEAN DEFAULT false",
        "date_realisation": "TIMESTAMP"
      }
    }
  },
  "user_roles": {
    "admin": {
      "field": "collaborateurs.is_admin = true",
      "description": "Administrateur - accès complet",
      "can_access": ["calendar", "collaborateurs", "clients", "impots", "tva", "temps_reels"],
      "special_permissions": [
        "Voir tous les collaborateurs et clients",
        "Modifier les droits admin/chef",
        "Envoyer rappels email à tous"
      ]
    },
    "chef_mission": {
      "field": "collaborateurs.est_chef_mission = true",
      "description": "Chef de mission - gère une équipe",
      "can_access": ["calendar", "collaborateurs", "clients", "impots", "tva", "temps_reels"],
      "special_permissions": [
        "Voir son équipe (collaborateurs assignés)",
        "Voir ses clients (chef_mission_id = son id)",
        "Planifier les charges de son équipe"
      ]
    },
    "collaborateur": {
      "field": "est_chef_mission = false AND is_admin = false",
      "description": "Collaborateur standard",
      "can_access": ["calendar", "collaborateurs (lecture)", "clients (lecture)"],
      "special_permissions": [
        "Voir uniquement ses propres charges",
        "Voir les clients de ses chefs"
      ]
    }
  },
  "helper_functions_in_app": {
    "note": "Ces fonctions sont définies dans App.jsx et utilisent les fonctions de businessLogic.js",
    "getChefsOf(collaborateurId)": "Retourne la liste des chefs d'un collaborateur",
    "getEquipeOf(chefId)": "Retourne la liste des membres de l'équipe d'un chef",
    "getAccessibleClients(collaborateur)": "Retourne les clients accessibles selon le rôle (inclut les inactifs pour saisie temps)",
    "loadAllData()": "Charge toutes les données depuis Supabase",
    "loadUserCollaborateur(email)": "Charge le collaborateur lié à l'utilisateur connecté"
  },
  "key_features_detail": {
    "calendar_views": {
      "week": "Vue par défaut - colonnes = collaborateurs filtrés, lignes = jours de la semaine",
      "month": "Grille calendrier mensuelle avec charges agrégées par jour",
      "day": "Vue journée détaillée"
    },
    "alerts_system": {
      "description": "Bulles colorées sur le calendrier indiquant les échéances fiscales",
      "colors": {
        "red": "Échéance non faite et date dépassée",
        "orange": "Échéance à faire dans les 3 jours",
        "green": "Échéance faite"
      },
      "types": ["TVA", "IS", "CVAE", "CFE", "DAS2", "Liasse fiscale"]
    },
    "pennylane_integration": {
      "sync_clients": "GET /api/customers - récupère la liste des clients",
      "mapping": "Liaison client local <-> pennylane_id pour import temps",
      "temps_import": "Export Excel depuis Pennylane -> import dans charges"
    },
    "excel_import_temps_reels": {
      "format": "Excel exporté depuis Pennylane (colonnes: Date, Collaborateur, Client, Heures, etc.)",
      "mapping_collab": "Automatique par email",
      "mapping_client": "Manuel ou automatique si pennylane_id existe",
      "modes": {
        "fusion": "Ajoute les heures aux charges existantes",
        "remplacement": "Remplace les heures réalisées existantes"
      }
    },
    "tva_auto_planning": {
      "inputs": ["Période (date début/fin)", "Heures par client", "Collaborateur assigné"],
      "algorithm": "Répartit les heures sur les jours ouvrés en respectant max 8h/jour",
      "constraints": ["Jours fériés français exclus", "Week-ends exclus", "Capacité collaborateur validée"]
    }
  },
  "cabinets": {
    "zerah": {
      "id": "zerah",
      "description": "Cabinet Zerah (cabinet principal)"
    },
    "audit_up": {
      "id": "audit_up",
      "description": "Cabinet Audit Up"
    }
  },
  "common_operations": {
    "add_charge": "CalendarPage -> AddChargeModal -> supabase.from('charges').insert()",
    "edit_charge": "CalendarPage -> EditChargeModal -> supabase.from('charges').update()",
    "delete_charge": "EditChargeModal -> supabase.from('charges').delete()",
    "sync_pennylane": "ClientsPage -> fetch Pennylane API -> compare & insert new clients",
    "import_temps": "TempsReelsPage -> parse Excel -> map collaborateurs/clients -> update charges.heures_realisees",
    "mark_echeance_done": "ImpotsTaxesPage ou CalendarPage -> supabase.from('suivi_echeances').upsert()"
  },
  "styling_conventions": {
    "background": "bg-slate-800/90 backdrop-blur-sm (cartes)",
    "borders": "border border-slate-700 rounded-lg",
    "buttons_primary": "${accent.color} text-white ${accent.hover}",
    "buttons_secondary": "bg-slate-700 hover:bg-slate-600 text-slate-300",
    "inputs": "bg-slate-700 text-white rounded px-3 py-2 border border-slate-600",
    "text_primary": "text-white",
    "text_secondary": "text-slate-300 ou text-slate-400"
  },
    "migrations": {
      "006_type_personne_siret.sql": "Ajout colonnes type_personne (PM/PP) + siret_complement sur clients",
      "007_unique_siren.sql": "UNIQUE INDEX sur (siren, COALESCE(siret_complement, '')) WHERE actif=true",
      "011_client_email.sql": "Ajout colonne email TEXT sur clients (contact synchronisé depuis Pennylane v2/customers)",
      "012_tarifs_reference.sql": "Table tarifs_reference: tarifs de référence 2025 par axe (compta, bilan, social, juridique, support) avec verrouillage"
    },
  "known_issues_and_todos": [
    "Pas de gestion d'erreurs centralisée",
    "Les jours fériés sont codés en dur (2025-2027)",
    "Les clés API sont en dur dans le code (Unsplash, Supabase) - à déplacer vers .env"
  ],
  "api/": {
    "description": "Fonctions serverless Vercel",
    "pennylane-proxy.js": {
      "role": "Proxy API Pennylane pour éviter CORS",
      "endpoint": "/api/pennylane-proxy",
      "method": "GET/POST/PUT/DELETE/PATCH",
      "headers_required": ["X-Pennylane-Api-Key"],
      "headers_optional": ["X-Company-Id (isolation par cabinet Pennylane)"],
      "query_params": ["endpoint", "...autres params transmis à Pennylane"],
      "target_api": "https://app.pennylane.com/api/external/v2"
    },
    "sync-pennylane.js": {
      "role": "Sync dossiers Pennylane (firm/v1 + v2/customers emails) → table clients",
      "endpoint": "/api/sync-pennylane",
      "method": "POST",
      "env_vars": ["PENNYLANE_AUDIT_UP_TOKEN", "PENNYLANE_ZERAH_FIDUCIAIRE_TOKEN", "SUPABASE_URL", "SUPABASE_SERVICE_KEY"],
      "steps": [
        "Étape 1: firm/v1/companies → sync dossiers (nom, SIREN, adresse, cabinet)",
        "Étape 2: v2/customers → enrichissement emails (clés API depuis pennylane_api_keys, match par SIREN)"
      ],
      "matching_strategy": [
        "1. Match par pennylane_id + cabinet (identifiant technique)",
        "2. Fallback par SIREN → TOUT client actif avec ce SIREN (pas seulement sans pennylane_id)",
        "3. Sinon insert nouveau client"
      ],
      "email_enrichment": "Lit les clés API depuis pennylane_api_keys (Supabase), appelle v2/customers directement côté serveur, match par SIREN, met à jour email",
      "anti_doublon": "Fallback SIREN élargi empêche la création de doublons même si le client existe via une autre source",
      "soft_delete": "Désactivé — la désactivation des clients est gérée manuellement par l'utilisateur"
    }
  },
  "database_tables_honoraires": {
    "abonnements": {
      "description": "Abonnements (subscriptions) Pennylane synchronisés",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id) NOT NULL",
        "pennylane_subscription_id": "INTEGER UNIQUE NOT NULL",
        "label": "TEXT (nom de l'abonnement)",
        "status": "TEXT ('in_progress', 'not_started', 'stopped', 'finished')",
        "frequence": "TEXT ('monthly', 'yearly')",
        "intervalle": "INTEGER DEFAULT 1",
        "jour_facturation": "INTEGER",
        "date_debut": "DATE",
        "date_fin": "DATE",
        "total_ttc": "DECIMAL(12,2)",
        "total_ht": "DECIMAL(12,2)",
        "total_tva": "DECIMAL(12,2)",
        "synced_at": "TIMESTAMP",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "updated_at": "TIMESTAMP DEFAULT NOW()"
      }
    },
    "abonnements_lignes": {
      "description": "Lignes de facturation des abonnements",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "abonnement_id": "INTEGER REFERENCES abonnements(id) ON DELETE CASCADE",
        "pennylane_line_id": "INTEGER",
        "label": "TEXT NOT NULL (nom du produit)",
        "famille": "TEXT ('comptabilite', 'social', 'juridique', 'support')",
        "quantite": "DECIMAL(10,2) DEFAULT 1",
        "montant_ttc": "DECIMAL(12,2)",
        "montant_ht": "DECIMAL(12,2)",
        "montant_tva": "DECIMAL(12,2)",
        "taux_tva": "TEXT",
        "description": "TEXT"
      }
    },
    "produits_facturation": {
      "description": "Référentiel des produits de facturation avec mapping famille",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "label": "TEXT UNIQUE NOT NULL",
        "famille": "TEXT ('comptabilite', 'social', 'juridique', 'support')",
        "inclus_calcul_temps": "BOOLEAN DEFAULT true",
        "actif": "BOOLEAN DEFAULT true"
      }
    },
    "types_mission": {
      "description": "Référentiel des types de mission pour calcul rentabilité",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "code": "TEXT UNIQUE NOT NULL",
        "libelle": "TEXT NOT NULL",
        "famille": "TEXT ('comptabilite', 'social', 'juridique', 'support')",
        "inclus_calcul_rentabilite": "BOOLEAN DEFAULT true"
      }
    }
  },
  "database_tables_tests_comptables": {
    "fournisseurs_releve": {
      "description": "Marquage des fournisseurs 'au relevé' ou 'ignorés' par client",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id) NOT NULL",
        "supplier_id": "TEXT NOT NULL (ID fournisseur Pennylane)",
        "supplier_name": "TEXT (nom fournisseur pour affichage)",
        "type": "TEXT ('releve' ou 'ignore') DEFAULT 'releve'",
        "created_by": "INTEGER REFERENCES collaborateurs(id)",
        "created_at": "TIMESTAMP DEFAULT NOW()"
      },
      "unique_constraint": "UNIQUE(client_id, supplier_id)",
      "used_by": "TestsComptablesPage.jsx - persistance des marquages fournisseurs"
    },
    "tests_comptables_executions": {
      "description": "Historique des exécutions de tests",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "client_id": "INTEGER REFERENCES clients(id)",
        "test_code": "TEXT (code du test exécuté)",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "millesime": "INTEGER (année fiscale)",
        "date_execution": "TIMESTAMP DEFAULT NOW()",
        "statut": "TEXT ('en_cours', 'termine', 'erreur')",
        "duree_ms": "INTEGER",
        "nombre_anomalies": "INTEGER DEFAULT 0"
      }
    },
    "tests_comptables_resultats": {
      "description": "Anomalies détectées par les tests",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "execution_id": "INTEGER REFERENCES tests_comptables_executions(id)",
        "type_anomalie": "TEXT",
        "severite": "TEXT ('info', 'warning', 'error', 'critical')",
        "donnees": "JSONB (données spécifiques à l'anomalie)",
        "commentaire": "TEXT",
        "traite": "BOOLEAN DEFAULT false",
        "traite_par": "INTEGER REFERENCES collaborateurs(id)",
        "traite_le": "TIMESTAMP"
      }
    }
  },
  "database_tables_salaires": {
    "_security": "TOUTES CES TABLES SONT PROTÉGÉES PAR RLS - ACCÈS ADMIN UNIQUEMENT",
    "salaires_collaborateurs": {
      "description": "Historique des salaires - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id) ON DELETE CASCADE",
        "annee": "INTEGER NOT NULL",
        "date_effet": "DATE NOT NULL (date d'effet du salaire)",
        "salaire_brut_annuel": "DECIMAL(12,2) NOT NULL",
        "charges_patronales_annuel": "DECIMAL(12,2) DEFAULT 0",
        "heures_annuelles": "INTEGER DEFAULT 1607 (base légale)",
        "motif_modification": "TEXT (Embauche, Augmentation, Promotion...)",
        "notes": "TEXT",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "updated_at": "TIMESTAMP DEFAULT NOW()",
        "created_by": "INTEGER REFERENCES collaborateurs(id)"
      },
      "rls_policy": "admin_full_access_salaires - USING (is_current_user_admin())"
    },
    "salaires_primes": {
      "description": "Primes et exceptionnels - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id) ON DELETE CASCADE",
        "annee": "INTEGER NOT NULL",
        "mois": "INTEGER (1-12, NULL = annuel)",
        "date_versement": "DATE",
        "type_prime": "TEXT (prime_exceptionnelle, prime_objectifs, 13eme_mois, participation, interessement, prime_anciennete, prime_vacances, autre)",
        "libelle": "TEXT NOT NULL",
        "montant_brut": "DECIMAL(10,2) NOT NULL",
        "charges_patronales": "DECIMAL(10,2) DEFAULT 0",
        "notes": "TEXT",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "created_by": "INTEGER REFERENCES collaborateurs(id)"
      },
      "rls_policy": "admin_full_access_primes - USING (is_current_user_admin())"
    },
    "salaires_simulations": {
      "description": "Simulations budgétaires augmentations - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "nom_simulation": "TEXT NOT NULL",
        "annee_cible": "INTEGER NOT NULL",
        "date_effet_prevue": "DATE",
        "statut": "TEXT (brouillon, valide, applique)",
        "notes": "TEXT",
        "created_at": "TIMESTAMP DEFAULT NOW()",
        "created_by": "INTEGER REFERENCES collaborateurs(id)",
        "validated_at": "TIMESTAMP",
        "validated_by": "INTEGER REFERENCES collaborateurs(id)"
      },
      "rls_policy": "admin_full_access_simulations - USING (is_current_user_admin())"
    },
    "salaires_simulations_lignes": {
      "description": "Détail des simulations par collaborateur - ACCES ADMIN UNIQUEMENT via RLS",
      "fields": {
        "id": "SERIAL PRIMARY KEY",
        "simulation_id": "INTEGER REFERENCES salaires_simulations(id) ON DELETE CASCADE",
        "collaborateur_id": "INTEGER REFERENCES collaborateurs(id)",
        "salaire_actuel_brut": "DECIMAL(12,2)",
        "charges_actuelles": "DECIMAL(12,2)",
        "type_augmentation": "TEXT (montant, pourcentage)",
        "valeur_augmentation": "DECIMAL(10,2)",
        "nouveau_salaire_brut": "DECIMAL(12,2)",
        "nouvelles_charges": "DECIMAL(12,2)",
        "notes": "TEXT"
      },
      "rls_policy": "admin_full_access_simulations_lignes - USING (is_current_user_admin())"
    }
  },
  "recent_changes": {
    "2025-01": [
      "Ajout typage JSDoc + @ts-check sur tous les fichiers",
      "Création de types.js avec toutes les définitions de types",
      "Extraction des fonctions métier dans businessLogic.js",
      "Setup framework de tests Vitest + React Testing Library",
      "Ajout de 96 tests (unitaires, composants, scénarios métier)",
      "Fix imports icônes manquants sur plusieurs pages",
      "Extension businessLogic.js avec 10 nouvelles fonctions calendrier",
      "Création calendarLogic.test.js (35 tests pré-refactoring)",
      "Refactoring CalendarPage.jsx: 3773 → 1424 lignes (-62%) - suppression code dupliqué",
      "Total tests: 131",
      "Ajout module tests comptables (testsComptables/)",
      "Ajout proxy API Pennylane (api/pennylane-proxy.js)",
      "Ajout page TestsComptablesPage.jsx",
      "Ajout validation clé API Pennylane avec test de connexion dans ClientsPage",
      "Ajout champ pennylane_client_api_key sur clients",
      "Analyse des écarts: ajout colonne Cabinet (ZG/AU) triable",
      "Analyse des écarts: ajout colonne Détail travail (commentaires agrégés depuis import Excel)",
      "Export Excel des écarts enrichi avec Cabinet et Détail travail",
      "Tri alphabétique des listes de clients dans toute l'application",
      "Recherche intégrée dans les dropdowns clients (EditChargeModal, TestsComptablesPage)",
      "Amélioration UX: ClientsPage, MergeClientModal, RepartitionTVAPage, TempsReelsPage triés",
      "Ajout module honoraires (src/utils/honoraires/)",
      "Ajout page HonorairesPage.jsx (admin only)",
      "Migration BDD: pennylane_customer_id changé de INTEGER à TEXT (UUID)",
      "Sync Pennylane: matching intelligent avec filtrage doublons (seuls customers avec abonnements)",
      "Tables BDD: abonnements, abonnements_lignes, produits_facturation, types_mission",
      "Ajout module salaires (src/utils/salaires/) - ADMIN ONLY avec RLS",
      "Ajout page SalairesPage.jsx avec 3 onglets: Salaires, Primes, Simulations",
      "Tables BDD salaires: salaires_collaborateurs, salaires_primes, salaires_simulations, salaires_simulations_lignes",
      "Sécurité RLS: fonction is_current_user_admin() + politiques sur toutes tables salaires",
      "Calcul taux horaire chargé basé sur 1607h annuelles légales",
      "Simulations d'augmentation: création, application vers nouveaux salaires"
    ],
    "2025-02": [
      "Test doubleSaisie renommé 'Relevé fournisseurs' - refonte complète du test",
      "Marquage fournisseurs 'au relevé' et 'ignorés' persisté en BDD (table fournisseurs_releve)",
      "Calendrier 12 mois par fournisseur au relevé (vert/orange/rouge/grisé)",
      "Mois cliquables dans calendrier relevé fournisseurs avec panneau détail",
      "Panneau détails mois via DOM pur (zéro re-render React) pour optimisation perf",
      "Liens PDF directs vers factures Pennylane dans panneau détail",
      "Suggestion marquage au relevé (icône ampoule) si doublons classiques détectés",
      "Section fournisseurs ignorés pliable avec bouton Restaurer",
      "TestsComptablesPage: 632 → 1091 lignes",
      "Ajout tests: doubleSaisie.test.js (14 tests), calculsSalaires.test.js (54 tests)",
      "Total tests: 158 → 226",
      "Attestation achats fournisseurs: nouveau test avec export Word (.docx) AUDIT UP",
      "Catégories Boissons/Food avec sous-totaux par catégorie",
      "Sélection fournisseurs par coches pour filtrer l'attestation Word",
      "API Pennylane: getFECByAccounts pour filtrage optimisé par ledger_account_id",
      "Champs adresse client (localStorage) pour en-tête attestation Word",
      "Retrait logique TVA/TTC (non nécessaire)",
      "Dépendance docx ajoutée pour génération Word côté navigateur"
    ],
    "2026-01": [
      "Module honoraires complet: syncHonoraires, silaeService, classificationAxes, calculsAugmentation, exportAugmentation",
      "Réconciliation CA: fix doublons abonnements arrêtés (3.4M→2.2M), 123/127 clients ISO au centime",
      "SIREN clé universelle: matching SIREN dans syncHonoraires, silaeService, sync-pennylane",
      "Remplissage SIREN: 168/168 clients (100%)",
      "type_personne PM/PP sur tous les clients (migration 006)",
      "Split mega-client LM en 5 entités distinctes (SCI LM, MAGP AUTEUIL, LMK INVEST, MICHEL MALRIC, FERIA CAFE)",
      "ClientModal.jsx: formulaire complet PM/PP + SIREN + NIC avec auto-force PM",
      "ClientsPage.jsx: colonnes Type/SIREN/NIC, export Excel enrichi",
      "Ajout silaeService.js avec matching SIREN",
      "Ajout SilaeMappingModal.jsx avec recherche SIREN"
    ],
    "2026-02": [
      "Fusion clients complète: transfert 9 tables FK (charges, abonnements, temps_reels, silae_productions...)",
      "Gestion doublons UNIQUE dans fusion (silae_productions par période, temps_reels par collab+date)",
      "Fusion de 6 paires de doublons SIREN (PP GESLIN, CHEZ RIBE POUVERIN, BALLU, FRANCE FORMALITES, MAGP AUTEUIL, PFA ASSOCIES)",
      "Migration 007: UNIQUE INDEX sur (siren, siret_complement) pour clients actifs",
      "sync-pennylane.js: fallback SIREN élargi à tous clients actifs pour anti-doublon",
      "MergeClientModal enrichi: message confirmation complet, liste cibles élargie",
      "Sync Pennylane avec prévisualisation: previewSync (diff sans écriture) + commitSync (applique + historique prix)",
      "SyncPreviewModal: rapport détaillé matching, abonnements, variations prix, anomalies avec accept/reject",
      "Support X-Company-Id dans pennylaneCustomersApi.js pour isolation par cabinet Pennylane",
      "Matching intelligent avec niveaux: uuid → siren → name_exact → name_clean → name_partial → name_clean_partial",
      "Détection anomalies: variations prix > 20%, clients inactifs avec abonnements actifs, matches faibles",
      "Gestion clients inactifs: accessibles pour saisie temps, exclus du calcul CA HT honoraires",
      "Badge orange 'inactif' dans dropdowns clients (AddCharge, EditCharge, TempsReels)",
      "Feedback sync déplacé hors conditionnel d'onglet (visible depuis tous les onglets)",
      "Badge 'En construction' sur onglet Vue par client",
      "Exclusion clients inactifs dans AugmentationPanel.jsx",
      "businessLogic.js: getAccessibleClients inclut les clients inactifs (aligné avec App.jsx)",
      "Ajout syncPreview.test.js (27 tests matching/anomalies/inactifs)",
      "Mise à jour businessLogic.test.js et scenarios.test.js pour clients inactifs",
      "Total tests: 226 → 365",
      "Migration 011: colonne email TEXT sur clients (synchronisé depuis Pennylane v2/customers)",
      "Email Pennylane: sync-pennylane.js enrichit les emails côté serveur via API v2/customers + match SIREN",
      "syncPreview.js + syncHonoraires.js: extraction emails[0] dans commitSync et updateData",
      "ClientsPage: colonne Email (mailto:), toutes colonnes triables (clic entête ▲/▼), recherche par email",
      "ClientModal: affichage email en lecture seule quand disponible",
      "Export Excel: colonne Email ajoutée",
      "Suppression soft delete automatique dans sync-pennylane.js (désactivation manuelle uniquement)",
      "Ajout 4 tests extraction email dans syncPreview.test.js",
      "Total tests: 365 → 375",
      "fix(sync): dédoublonnage clients inactifs dans previewSync (évite doublons matches)",
      "fix(temps-reels): validation FK avant insert + correction 5 mappings cassés (TempsReelsPage.jsx)",
      "Outil de réconciliation PL↔DB: reconciliation.js (287 lignes) avec matching STRICT SIREN+UUID uniquement",
      "Réconciliation: exclusion France Formalités, déduplication, SIREN ambigu multi-établissements",
      "HonorairesPage.jsx: 780 → 1626 lignes, ajout onglet Réconciliation (4 onglets total)",
      "Correction matching SIREN ambigu dans syncHonoraires.js + syncPreview.js (disambiguation par UUID)",
      "pennylaneCustomersApi.js: setCompanyId exporté pour réconciliation multi-cabinets",
      "Ajout reconciliation.test.js (20 tests) + enrichissement syncHonoraires.test.js et syncPreview.test.js",
      "Total tests: 375 → 406",
      "fix(honoraires): classification social PAR LIGNE au lieu de mode client global (écart CA 2.66M→2.22M corrigé)",
      "classificationAxes.js: 8 axes d'augmentation, classification par label/qté/prix unitaire",
      "detectModeFacturationSocial: exclusion accessoires, détection par label, AFFICHAGE uniquement",
      "diagnosticHonoraires.js: Pattern 7 prix social suspects (bulletin < 1€, > 30€, forfait < 30€)",
      "auditHonoraires.js: check 5 prix social suspects + détection clients mixtes (forfait+bulletin) via Supabase",
      "tarifsReferenceService.js + migration 012_tarifs_reference.sql: table tarifs_reference 2025",
      "AugmentationPanel.jsx: 1110 lignes, UI tarifs de référence + verrouillage augmentation",
      "DiagnosticModal.jsx: 343 lignes, modal diagnostic anomalies (7 patterns)",
      "exportAugmentation.js: 619 lignes, export Excel multi-feuilles (Résumé, Détail, Par axe, Prix suspects)",
      "HonorairesPage.jsx: 1626 → 1925 lignes, section 5 Audit prix suspects + Excel",
      "Total tests: 406 → 414",
      "feat(honoraires): sauvegarde tarifs en 2 étapes — baseline 2025 + augmentation 2026",
      "tarifsReferenceService.js: ajout sauvegarderTarifsBaseline() (ancien_prix_unitaire_ht) avec progress callback",
      "AugmentationPanel.jsx: handleSaveTarifs en 2 étapes (baseline 0-50%, augmentation 50-100%)",
      "AugmentationPanel.jsx: bouton dynamique (Baseline 2025... X% / Augmentation 2026... X%)",
      "AugmentationPanel.jsx: modale confirmation explique les 2 étapes (2025-01-01 + 2026-01-01)",
      "AugmentationPanel.jsx: résultat affiché '594 tarifs 2025 + 594 tarifs 2026'",
      "index.js: export sauvegarderTarifsBaseline ajouté",
      "Ajout tarifsReferenceService.test.js (19 tests): baseline, reference, type_recurrence, progress",
      "Migration 012 exécutée en prod: 64 produits (29 Zerah + 35 Audit Up), 1126 tarifs (563 × 2 dates)",
      "Données vérifiées: 563 tarifs 2025 + 563 tarifs 2026, Zerah 308 / Audit Up 818, fixe 656 / variable 470",
      "Total tests: 414 → 433",
      "feat(honoraires): Phase 2 — Restructuration des abonnements PL (séparation fixe/variable)",
      "subscriptionRestructuration.js: analyserClient + analyserTousLesClients + calculerStatistiques",
      "exportRestructuration.js: Excel 4 onglets (Résumé, Import PL fixe, A supprimer, Détail croisé)",
      "RestructurationPanel.jsx: UI Phase 2 avec mode single/batch, KPIs, arborescence client→abo→ligne",
      "HonorairesPage.jsx: ajout onglet Restructuration (5 onglets total: vue, augmentation, restructuration, audit, reconciliation)",
      "index.js: exports analyserClient, analyserTousLesClients, calculerStatistiques, exportRestructurationExcel",
      "Ajout subscriptionRestructuration.test.js (12 tests): HFC INVEST, séparation fixe/variable, décisions, prix 2026, stats",
      "Test client HFC INVEST: 5 fixes + 6 variables, 4 abonnements, décision correcte (3 inchangés + 1 à supprimer)",
      "Total tests: 433 → 445",
      "feat(honoraires): Phase 3 — Facturation variable mensuelle (Silae → Excel PL brouillons)",
      "facturationVariableService.js: croisement Silae × tarifs × produits PL, génération facturation par client",
      "exportFacturationVariable.js: export Excel format STRICT PL brouillons, 1 fichier par cabinet (AUP/ZF)",
      "FacturationVariablePanel.jsx: UI Phase 3 avec mode single/batch, sync produits PL, export",
      "pennylaneCustomersApi.js: ajout getAllProducts (GET /products paginé)",
      "silaeService.js: ajout colonne editique (col L Silae) dans parseur + import",
      "HonorairesPage.jsx: ajout onglet Facturation (6 onglets total: vue, augmentation, restructuration, facturation, audit, reconciliation)",
      "index.js: exports Phase 3 (genererFacturationVariable, syncProduitsPennylane, exportFacturationVariableExcel, getAllProducts)",
      "Migration 013: ALTER TABLE silae_productions ADD COLUMN editique",
      "Format Excel validé en import PL: SIREN nombre, TVA 0.00%, date serial m/d/yy, feuille Feuil1",
      "Nommage fichiers: 'AUP Janvier 26 a importer dans PL.xlsx', période ajoutée au nom produit",
      "feat(honoraires): upload Silae dans FacturationVariablePanel + API write PL + docs",
      "FacturationVariablePanel.jsx: upload fichier Silae avec sélecteur mois/année + SilaeMappingModal",
      "silaeService.js: extractPeriodeFromFilename exportée (partagée AugmentationPanel + FacturationVariablePanel)",
      "pennylane-proxy.js: support PUT/DELETE/PATCH + gestion 204 No Content",
      "pennylaneCustomersApi.js: callPennylaneWriteAPI + listCustomerInvoices/deleteDraftInvoice/updateDraftInvoice/deleteSubscription/createSubscription",
      "docs/modop-facturation-variable.md + docs/modop-nettoyage-pennylane.md créés",
      "Nettoyage PL 2025→2026: Op1 (40 brouillons supprimés), Op2 (72 prix brouillons mis à jour), Op3 (42 abos variables supprimés), Op4a (235 abos fixes supprimés)",
      "exportRestructuration.js: split Import PL en 2 onglets par cabinet (Import PL AUP + Import PL ZF), trié par nom",
      "Ajout exportRestructuration.test.js (24 tests): structure, split cabinet, format colonnes, données, dates, cas limites",
      "Total tests: 504 → 528",
      "exportRestructuration.js: nouveau format PL 2026 (10 cols fixes + 4 cols/ligne produit, HT direct, UUID produit, SIREN, Millésime)",
      "exportRestructuration.test.js: réécrit pour format PL 2026 (24 → 32 tests, +8 tests UUID matching)",
      "Total tests: 528 → 536"
    ]
  }
}
